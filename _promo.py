# -*- coding: utf-8 -*-
"""_PROMO.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1WJ7nBPnfKvd_HEJwL79DaSlbRPf4rjQS
"""

from google.colab import drive

# L·ªánh n√†y s·∫Ω mount Google Drive v√†o th∆∞ m·ª•c /content/drive
drive.mount('/content/drive')

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import warnings
warnings.filterwarnings('ignore')

ROSSMANN_RED = '#C3002D'      # M√†u ch√≠nh (Primary)
ROSSMANN_GREY = '#888888'     # M√†u ph·ª• 1 (Secondary 1 - D√πng cho ƒë·ªëi chi·∫øu/No Promo)
ROSSMANN_LIGHT_GREY = '#C3C3C3' # M√†u ph·ª• 2 (Grid/Background)
TEXT_COLOR = '#333333'        # M√†u ch·ªØ

PROMO_PALETTE = {
    0: ROSSMANN_GREY,      1: ROSSMANN_RED,
    '0': ROSSMANN_GREY,    '1': ROSSMANN_RED,
    'No_Promo': ROSSMANN_GREY, 'Promo': ROSSMANN_RED # Th√™m key string cho ch·∫Øc ch·∫Øn
}
MAIN_COLOR = ROSSMANN_RED

import pandas as pd

# 1. Load d·ªØ li·ªáu (ƒê·∫£m b·∫£o ƒë∆∞·ªùng d·∫´n file ƒë√∫ng v·ªõi Drive c·ªßa b·∫°n)
train = pd.read_csv('/content/drive/MyDrive/data_ml/train.csv', dtype={'StateHoliday': str})
store = pd.read_csv('/content/drive/MyDrive/data_ml/store.csv')
train['Date'] = pd.to_datetime(train['Date'])

# 2. Ki·ªÉm tra d·ªØ li·ªáu ng√†y thi·∫øu
store_date_counts = train.groupby('Store')['Date'].nunique()
expected_days = (train['Date'].max() - train['Date'].min()).days + 1
duplicate_store_dates = store_date_counts[store_date_counts < expected_days]

# L·∫•y danh s√°ch c√°c c·ª≠a h√†ng thi·∫øu ng√†y
incomplete_stores = duplicate_store_dates.index.tolist()

# 3. Gi·ªØ l·∫°i c·ª≠a h√†ng 988 (Remove 988 kh·ªèi danh s√°ch b·ªã x√≥a)
if 988 in incomplete_stores:
    incomplete_stores.remove(988)

print(f"S·ªë l∆∞·ª£ng c·ª≠a h√†ng s·∫Ω b·ªã x√≥a: {len(incomplete_stores)}")

# 4. Lo·∫°i b·ªè c√°c c·ª≠a h√†ng n√†y kh·ªèi t·∫≠p Train v√† Store
train_clean = train[~train['Store'].isin(incomplete_stores)]
store_clean = store[~store['Store'].isin(incomplete_stores)]

# 5. IN RA K·∫æT QU·∫¢ C√íN L·∫†I (Output b·∫°n c·∫ßn)
print("-" * 30)
print(f"T·ªïng s·ªë c·ª≠a h√†ng ban ƒë·∫ßu: {train['Store'].nunique()}")
print(f"S·ªë l∆∞·ª£ng c·ª≠a h√†ng c√≤n l·∫°i trong Train: {train_clean['Store'].nunique()}")
print(f"S·ªë l∆∞·ª£ng c·ª≠a h√†ng c√≤n l·∫°i trong Store: {store_clean['Store'].nunique()}")
print("-" * 30)

# Merge data
df_merge = pd.merge(train_clean, store_clean, on='Store', how='left')
print("\n--- D·ªØ li·ªáu TH√î sau khi merge ---")
print(f"T·ªïng s·ªë d√≤ng: {df_merge.shape[0]}")
print(f"T·ªïng s·ªë c·ªôt: {df_merge.shape[1]}")
display(df_merge.head())

"""### Data Dictionary (T·ª´ ƒëi·ªÉn d·ªØ li·ªáu)

| T√™n C·ªôt | Ngu·ªìn | √ù Nghƒ©a & Gi·∫£i Th√≠ch Chi Ti·∫øt |
| :--- | :---: | :--- |
| **Store** | C·∫£ 2 | ID ƒë·ªãnh danh duy nh·∫•t c·ªßa m·ªói c·ª≠a h√†ng (Key ƒë·ªÉ merge). |
| **DayOfWeek** | Train | Ng√†y trong tu·∫ßn (1 = Th·ª© 2, ..., 7 = Ch·ªß Nh·∫≠t). |
| **Date** | Train | Ng√†y ph√°t sinh giao d·ªãch. |
| **Sales** | Train | **Bi·∫øn m·ª•c ti√™u (Target Variable):** Doanh thu trong ng√†y. |
| **Customers** | Train | S·ªë l∆∞·ª£ng kh√°ch h√†ng ƒë·∫øn mua s·∫Øm trong ng√†y. |
| **Open** | Train | Tr·∫°ng th√°i c·ª≠a h√†ng: `0` = ƒê√≥ng c·ª≠a, `1` = M·ªü c·ª≠a. |
| **Promo** | Train | **Khuy·∫øn m√£i ng·∫Øn h·∫°n:** `1` = C·ª≠a h√†ng ƒëang ch·∫°y promo ng√†y h√¥m ƒë√≥, `0` = Kh√¥ng. |
| **StateHoliday** | Train | Ng√†y ngh·ªâ l·ªÖ qu·ªëc gia: `a` = Public holiday, `b` = Easter, `c` = Christmas, `0` = Ng√†y th∆∞·ªùng. |
| **SchoolHoliday** | Train | Ng√†y ngh·ªâ h·ªçc: `1` = Tr∆∞·ªùng c√¥ng l·∫≠p ƒë√≥ng c·ª≠a v√†o ng√†y ƒë√≥, `0` = Kh√¥ng. |
| **StoreType** | Store | M√¥ h√¨nh c·ª≠a h√†ng: C√≥ 4 lo·∫°i `a`, `b`, `c`, `d` (V√≠ d·ª•: c·ª≠a h√†ng nh·ªè, si√™u th·ªã l·ªõn...). |
| **Assortment** | Store | M·ª©c ƒë·ªô ƒëa d·∫°ng h√†ng h√≥a: `a` = Basic (C∆° b·∫£n), `b` = Extra (Th√™m), `c` = Extended (M·ªü r·ªông). |
| **CompetitionDistance** | Store | Kho·∫£ng c√°ch (m√©t) ƒë·∫øn ƒë·ªëi th·ªß c·∫°nh tranh g·∫ßn nh·∫•t. |
| **CompetitionOpenSince[Month/Year]** | Store | Th·ªùi ƒëi·ªÉm (Th√°ng/NƒÉm) ƒë·ªëi th·ªß c·∫°nh tranh g·∫ßn nh·∫•t b·∫Øt ƒë·∫ßu m·ªü c·ª≠a. |
| **Promo2** | Store | **Khuy·∫øn m√£i d√†i h·∫°n/ti·∫øp di·ªÖn:** `0` = Kh√¥ng tham gia, `1` = C√≥ tham gia. |
| **Promo2Since[Week/Year]** | Store | Tu·∫ßn v√† NƒÉm b·∫Øt ƒë·∫ßu tham gia ch∆∞∆°ng tr√¨nh Promo2. |
| **PromoInterval** | Store | C√°c th√°ng m√† Promo2 ƒë∆∞·ª£c kh·ªüi ƒë·ªông l·∫°i (V√≠ d·ª•: "Jan,Apr,Jul,Oct"). |
"""

# L·ªçc d·ªØ li·ªáu: Ch·ªâ l·∫•y nh·ªØng ng√†y c·ª≠a h√†ng M·ªû C·ª¨A (Open == 1) v√† c√≥ Doanh thu > 0
# L√Ω do: N·∫øu t√≠nh c·∫£ ng√†y ƒë√≥ng c·ª≠a (Sales=0), trung b√¨nh c·ªßa "Kh√¥ng Promo" s·∫Ω b·ªã k√©o xu·ªëng th·∫•p sai l·ªách.
df_open = df_merge[(df_merge['Open'] == 1) & (df_merge['Sales'] > 0)].copy()

print("\n--- CHIÃâ L√ÇÃÅY NH∆ØÃÉNG NGAÃÄY M∆†Ãâ C∆ØÃâA VAÃÄ COÃÅ DOANH THU > O ---")
print(f"T·ªïng s·ªë d√≤ng: {df_open.shape[0]}")
print(f"T·ªïng s·ªë c·ªôt: {df_open.shape[1]}")
display(df_open.head())

"""# L√ÄM CH·ª¶ "V≈® KH√ç" PROMO!"""

# Ensure 'Promo' column is of integer type for correct palette mapping right before plotting
df_open['Promo'] = df_open['Promo'].astype(int)

# ---  T√≠nh to√°n Sales Uplift (Lift Analysis) ---
# T√≠nh trung b√¨nh Sales theo nh√≥m Promo
promo_stats = df_open.groupby('Promo')['Sales'].mean()
sales_no_promo = promo_stats[0]
sales_promo = promo_stats[1]

# T√≠nh % tƒÉng tr∆∞·ªüng (Uplift)
uplift = ((sales_promo - sales_no_promo) / sales_no_promo) * 100

print(f"--- K·∫æT QU·∫¢ PH√ÇN T√çCH T√ÅC ƒê·ªòNG C·ª¶A PROMO ---")
print(f"Doanh thu trung b√¨nh (Kh√¥ng Promo): {sales_no_promo:,.0f}")
print(f"Doanh thu trung b√¨nh (C√≥ Promo):    {sales_promo:,.0f}")
print(f"Sales Uplift (M·ª©c tƒÉng tr∆∞·ªüng):     {uplift:.2f}%")
print("-" * 50)


# ---  Tr·ª±c quan h√≥a (Boxplot & Violin Plot) ---
plt.figure(figsize=(14, 6))

# Bi·ªÉu ƒë·ªì 1: Boxplot - Hi·ªÉn th·ªã ph√¢n ph·ªëi v√† c√°c gi√° tr·ªã ngo·∫°i lai (Outliers)
plt.subplot(1, 2, 1)
sns.boxplot(x='Promo', y='Sales', data=df_open, palette=PROMO_PALETTE, showfliers=False) # showfliers=False ƒë·ªÉ ·∫©n b·ªõt c√°c ƒëi·ªÉm ngo·∫°i lai qu√° xa gi√∫p nh√¨n chart g·ªçn h∆°n
plt.title('Ph√¢n ph·ªëi Doanh thu: Promo vs No Promo (Boxplot)', fontsize=14)
plt.xlabel('Tr·∫°ng th√°i Promo (0=Kh√¥ng, 1=C√≥)')
plt.ylabel('Doanh thu (Sales)')

# Bi·ªÉu ƒë·ªì 2: Violin Plot - Hi·ªÉn th·ªã m·∫≠t ƒë·ªô d·ªØ li·ªáu (ƒë·ªô ph√¨nh c·ªßa bi·ªÉu ƒë·ªì)
plt.subplot(1, 2, 2)
sns.violinplot(x='Promo', y='Sales', data=df_open, palette=PROMO_PALETTE)
plt.title('M·∫≠t ƒë·ªô Doanh thu: Promo vs No Promo (Violin Plot)', fontsize=14)
plt.xlabel('Tr·∫°ng th√°i Promo (0=Kh√¥ng, 1=C√≥)')
plt.ylabel('Doanh thu (Sales)')

plt.tight_layout()
plt.show()

#  T√≠nh to√°n ch·ªâ s·ªë SalesPerCustomer (Basket Size)
df_open['BasketSize'] = df_open['Sales'] / df_open['Customers']

#  T√≠nh to√°n c√°c ch·ªâ s·ªë trung b√¨nh theo Promo
promo_stats = df_open.groupby('Promo')[['Sales', 'Customers', 'BasketSize']].mean().reset_index()

# T√≠nh % tƒÉng tr∆∞·ªüng
traffic_growth = (promo_stats.loc[1, 'Customers'] - promo_stats.loc[0, 'Customers']) / promo_stats.loc[0, 'Customers'] * 100
basket_growth = (promo_stats.loc[1, 'BasketSize'] - promo_stats.loc[0, 'BasketSize']) / promo_stats.loc[0, 'BasketSize'] * 100

print(f"=== Hi·ªáu qu·∫£ c·ªßa Promo ===")
print(f"TƒÉng tr∆∞·ªüng L∆∞·ª£ng kh√°ch (Traffic): {traffic_growth:.2f}%")
print(f"TƒÉng tr∆∞·ªüng Gi√° tr·ªã gi·ªè h√†ng (Basket Size): {basket_growth:.2f}%")
# T·∫°o khung h√¨nh (Figure) v·ªõi 1 h√†ng v√† 2 c·ªôt
fig, axes = plt.subplots(1, 2, figsize=(14, 6))
# --- BI·ªÇU ƒê·ªí 2: Boxplot S·ª©c mua (BasketSize) ---
sns.boxplot(data=df_open, x='Promo', y='BasketSize', palette=PROMO_PALETTE,
            ax=axes[0], showfliers=False)
axes[0].set_title('S·ª©c mua trung b√¨nh (BasketSize)')
axes[0].set_ylabel('Sales Per Customer')

# --- BI·ªÇU ƒê·ªí 3: Boxplot L∆∞·ª£ng kh√°ch (Customers) ---
sns.boxplot(data=df_open, x='Promo', y='Customers', palette=PROMO_PALETTE,
            ax=axes[1], showfliers=False)
axes[1].set_title('S·ªë l∆∞·ª£ng kh√°ch h√†ng khi: 0 : ng√†y th∆∞·ªùng, 1: c√≥ Promo ')
axes[1].set_ylabel('Customers')

# CƒÉn ch·ªânh l·∫°i kho·∫£ng c√°ch gi·ªØa c√°c bi·ªÉu ƒë·ªì cho ƒë·∫πp
plt.tight_layout()
plt.show()

"""## 1.BING

Promo l√† m·ªôt v≈© kh√≠ m·∫°nh m·∫Ω!

- Promo gi√∫p doanh thu trung b√¨nh tƒÉng t·ª´ 5900 l√™n 8200, t∆∞∆°ng ƒë∆∞∆°ng m·ª©c tƒÉng tr∆∞·ªüng 38.77%.

- Promo kh√¥ng ch·ªâ l√¥i k√©o th√™m kh√°ch h√†ng m·ªõi (Traffic tƒÉng 21%) m√† c√≤n khi·∫øn h·ªç ch·ªãu chi nhi·ªÅu h∆°n cho m·ªói l·∫ßn mua (Gi√° tr·ªã gi·ªè h√†ng tƒÉng 13.8%).

Nh∆∞ng n·∫øu s·ª≠ d·ª•ng sai ch·ªó, th√¨ kh√¥ng ch·ªâ l√£ng ph√≠ v·ªën ƒë·∫ßu t∆∞ cho ch∆∞∆°ng tr√¨nh promo m√† c√≤n, gi·∫øt ch·∫øt l·ª£i nhu·∫≠n.

Trong b√†i tr√¨nh b√†y n√†y, ch√∫ng ta s·∫Ω ƒëi qua 3 ƒëi·ªÉm m·∫•u ch·ªët ƒë·ªÉ bi·∫øn Promo t·ª´ m·ªôt chi ph√≠ l√£ng ph√≠ th√†nh ƒë·ªông l·ª±c tƒÉng tr∆∞·ªüng th·ª±c s·ª±:


**·ªû ƒë√¢u:** T·∫°i sao ch√∫ng ta ph·∫£i ng·ª´ng ngay l·∫≠p t·ª©c khuy·∫øn m√£i ·ªü S√¢n bay/Nh√† ga (Store 'b') v√† d·ªìn to√†n l·ª±c v√†o khu d√¢n c∆∞ (Store 'a').



**Khi n√†o:** T·∫°i sao Th·ª© Hai l√† "m·ªè v√†ng" c√≤n Th·ª© S√°u l√† v√πng ƒë·∫•t ch·∫øt, v√† ngh·ªãch l√Ω v·ªÅ h√†nh vi mua s·∫Øm tr∆∞·ªõc - sau l·ªÖ.






**Chi·∫øn l∆∞·ª£c:** C√°ch d√πng Promo ƒë·ªÉ ph√≤ng th·ªß tr∆∞·ªõc ƒë·ªëi th·ªß s√°t v√°ch v√† h√∫t kh√°ch t·ª´ xa.

## 2.BANG

### A. Ngh·ªãch l√Ω v·ªÅ ƒê·ªãa ƒëi·ªÉm: "Thu·ªëc ƒë·ªôc" v√† "Ng√¥i sao s√°ng"
"""

# 1. THI·∫æT L·∫¨P GI·∫¢ ƒê·ªäNH & L·ªåC D·ªÆ LI·ªÜU
MARGIN_NO_PROMO = 0.40  # 40% L·ª£i nhu·∫≠n
MARGIN_WITH_PROMO = 0.30  # 30% L·ª£i nhu·∫≠n

# --- QUAN TR·ªåNG: CH·ªà L·∫§Y D·ªÆ LI·ªÜU T·ª™ TH·ª® 2 ƒê·∫æN TH·ª® 6 ---
# Gi·∫£ ƒë·ªãnh: DayOfWeek 1=Mon, ..., 5=Fri, 6=Sat, 7=Sun
# Lo·∫°i b·ªè ho√†n to√†n T7 v√† CN ra kh·ªèi t√≠nh to√°n
df_weekdays = df_open[df_open['DayOfWeek'] <= 5].copy()

# 2. T√çNH TO√ÅN GROSS PROFIT TR√äN D·ªÆ LI·ªÜU ƒê√É L·ªåC
df_weekdays['GrossProfit'] = np.where(
    df_weekdays['Promo'] == 1,
    df_weekdays['Sales'] * MARGIN_WITH_PROMO,
    df_weekdays['Sales'] * MARGIN_NO_PROMO
)

# 3. T·ªîNG H·ª¢P D·ªÆ LI·ªÜU (GROUPBY & PIVOT)
# T√≠nh trung b√¨nh theo StoreType v√† Promo
stats = df_weekdays.groupby(['StoreType', 'Promo'])['GrossProfit'].mean().reset_index()

# Pivot b·∫£ng
table = stats.pivot(index='StoreType', columns='Promo', values='GrossProfit')
table.columns = ['Avg_Profit_NoPromo', 'Avg_Profit_Promo']

# T√≠nh % TƒÉng tr∆∞·ªüng (Uplift)
table['Profit_Uplift_%'] = ((table['Avg_Profit_Promo'] - table['Avg_Profit_NoPromo']) / table['Avg_Profit_NoPromo']) * 100

# Hi·ªÉn th·ªã b·∫£ng s·ªë li·ªáu tr∆∞·ªõc khi v·∫Ω
print("--- B·∫¢NG HI·ªÜU QU·∫¢ L·ª¢I NHU·∫¨N (CH·ªà T√çNH TH·ª® 2 - TH·ª® 6) ---")
display(table.style.background_gradient(cmap='RdYlGn', subset=['Profit_Uplift_%']).format("{:,.1f}"))

# --- 1. CHU·∫®N B·ªä D·ªÆ LI·ªÜU (GI·ªÆ NGUY√äN PH·∫¶N T√çNH TO√ÅN C·ª¶A B·∫†N) ---
# (ƒê·∫£m b·∫£o b·∫°n ƒë√£ ch·∫°y ph·∫ßn t√≠nh to√°n table ·ªü tr√™n)
# T√≠nh ch√™nh l·ªách tuy·ªát ƒë·ªëi (S·ªë ti·ªÅn L√£i/L·ªó th·ª±c t·∫ø)
table['Profit_Diff'] = table['Avg_Profit_Promo'] - table['Avg_Profit_NoPromo']

# S·∫Øp x·∫øp l·∫°i d·ªØ li·ªáu theo m·ª©c ƒë·ªô L√£i/L·ªó ƒë·ªÉ bi·ªÉu ƒë·ªì ƒë·∫πp h∆°n
table_sorted = table.sort_values('Profit_Diff', ascending=True)

# --- 2. V·∫º BI·ªÇU ƒê·ªí DIVERGING BAR CHART ---
plt.figure(figsize=(12, 6))

# T·∫°o danh s√°ch m√†u: ƒê·ªè n·∫øu L·ªó (√Çm), Xanh l√° n·∫øu L√£i (D∆∞∆°ng)
# L∆∞u √Ω: ROSSMANN_RED ƒë√£ ƒë∆∞·ª£c define ·ªü ƒë·∫ßu file, ta d√πng m√†u xanh chu·∫©n c·ªßa t√†i ch√≠nh cho ph·∫ßn L√£i
colors = [ROSSMANN_RED if x < 0 else '#27ae60' for x in table_sorted['Profit_Diff']]

# V·∫Ω bi·ªÉu ƒë·ªì c·ªôt ngang (Horizontal Bar)
bars = plt.barh(table_sorted.index, table_sorted['Profit_Diff'], color=colors, alpha=0.9)

# --- 3. TRANG TR√ç BI·ªÇU ƒê·ªí ---
plt.title('HI·ªÜU QU·∫¢ L·ª¢I NHU·∫¨N TH·ª∞C T·∫æ: PROMO vs NO PROMO',
          fontsize=16, fontweight='bold', pad=20, color='#34495E')
plt.xlabel('Ch√™nh l·ªách L·ª£i Nhu·∫≠n G·ªôp Trung B√¨nh ($)', fontsize=12, fontweight='bold')
plt.ylabel('Lo·∫°i C·ª≠a H√†ng (StoreType)', fontsize=12, fontweight='bold')

# V·∫Ω ƒë∆∞·ªùng trung t√¢m (Zero line)
plt.axvline(x=0, color='black', linestyle='-', linewidth=1)

# Th√™m l∆∞·ªõi m·ªù d·ªçc
plt.grid(axis='x', linestyle='--', alpha=0.5)

# --- 4. G·∫ÆN NH√ÉN GI√Å TR·ªä (ANNOTATION) ---
# H√†m g·∫Øn nh√£n th√¥ng minh: L·ªó th√¨ g·∫Øn b√™n tr√°i c·ªôt, L√£i th√¨ g·∫Øn b√™n ph·∫£i c·ªôt
for bar, val, pct in zip(bars, table_sorted['Profit_Diff'], table_sorted['Profit_Uplift_%']):
    # ƒê·ªãnh d·∫°ng text: "$Ti·ªÅn (+/-%)"
    label_text = f"${val:,.0f}\n({pct:+.1f}%)"

    # X√°c ƒë·ªãnh v·ªã tr√≠ v√† cƒÉn l·ªÅ
    if val < 0:
        align = 'right'
        x_pos = val - 10 # ƒê·∫©y sang tr√°i m·ªôt ch√∫t
        txt_color = ROSSMANN_RED
    else:
        align = 'left'
        x_pos = val + 10 # ƒê·∫©y sang ph·∫£i m·ªôt ch√∫t
        txt_color = '#27ae60'

    plt.text(x_pos, bar.get_y() + bar.get_height()/2, label_text,
             va='center', ha=align, fontsize=11, fontweight='bold', color=txt_color)

# ƒêi·ªÅu ch·ªânh gi·ªõi h·∫°n tr·ª•c X ƒë·ªÉ nh√£n kh√¥ng b·ªã c·∫Øt (M·ªü r·ªông th√™m 15% v·ªÅ 2 ph√≠a)
x_min, x_max = table_sorted['Profit_Diff'].min(), table_sorted['Profit_Diff'].max()
plt.xlim(x_min * 1.25, x_max * 1.25)

plt.tight_layout()
plt.show()

"""### *** Store 'b' (S√¢n bay/Nh√† ga) - N∆°i Promo l√† "Thu·ªëc ƒë·ªôc":***

Kh√°ch h√†ng b∆∞·ªõc v√†o Store 'b' (S√¢n bay/Nh√† ga) l√† nh·ªØng ng∆∞·ªùi ƒëang v·ªôi v√£, nh·ªØng du kh√°ch l·ª° ƒë∆∞·ªùng, ho·∫∑c nh·ªØng ng∆∞·ªùi ƒëang ch·ªù t√†u xe.

H·ªç c·∫ßn g√¨? S·ª± ti·ªán l·ª£i t·ª©c th√¨.

H·ªç quan t√¢m g√¨? "C√≥ h√†ng hay kh√¥ng", ch·ª© kh√¥ng ph·∫£i "Gi√° bao nhi√™u".

ƒê√¢y l√† nh√≥m kh√°ch h√†ng c√≥ ƒë·ªô nh·∫°y c·∫£m v·ªÅ gi√° c·ª±c th·∫•p (Low Price Elasticity). M·ªôt chai n∆∞·ªõc su·ªëi hay m·ªôt g√≥i khƒÉn gi·∫•y ·ªü ƒë√¢y d√π c√≥ b√°n nguy√™n gi√° th√¨ h·ªç v·∫´n b·∫Øt bu·ªôc ph·∫£i mua.

Khi ch·∫°y Promo, l·ª£i nhu·∫≠n Store 'b' gi·∫£m 9.9%.
B·ªüi v√¨ khi b·∫°n gi·∫£m gi√° t·∫°i S√¢n bay/Nh√† ga, b·∫°n ƒëang "t·∫∑ng ti·ªÅn" cho nh·ªØng ng∆∞·ªùi v·ªën dƒ© ƒë√£ s·∫µn s√†ng tr·∫£ ƒë·ªß ti·ªÅn.

B·∫°n kh√¥ng c·∫ßn Promo ƒë·ªÉ k√©o kh√°ch v√†o (Traffic Driver) v√¨ kh√°ch ƒë√£ ·ªü s·∫µn ƒë√≥ r·ªìi (h·ªç ƒëang ch·ªù t√†u/m√°y bay).

B·∫°n kh√¥ng c·∫ßn Promo ƒë·ªÉ tƒÉng gi√° tr·ªã gi·ªè h√†ng (Basket Size) v√¨ h·ªç ch·ªâ mua ƒë√∫ng th·ª© h·ªç c·∫ßn ƒë·ªÉ mang ƒëi.

Vi·ªác ch·∫°y Promo ·ªü Store 'b' gi·ªëng nh∆∞ vi·ªác b·∫°n b√°n v√© h·∫°ng th∆∞∆°ng gia v·ªõi gi√° v√© h·∫°ng ph·ªï th√¥ng cho m·ªôt ng∆∞·ªùi t·ªâ ph√∫. H·ªç s·∫Ω mua, nh∆∞ng b·∫°n m·∫•t ƒëi m·ªôt kho·∫£n l·ª£i nhu·∫≠n kh·ªïng l·ªì m√† kh√¥ng thu l·∫°i th√™m ƒë∆∞·ª£c l·ª£i √≠ch g√¨.

### *** Store 'a' v√† 'd' (Khu d√¢n c∆∞) - "Ng√¥i sao s√°ng" ***

Ng∆∞·ª£c l·∫°i, StoreType 'd' v√† 'a' (v·ªõi Assortment Basic) l·∫°i l√† nh·ªØng "ng√¥i sao s√°ng". ƒê·∫∑c bi·ªát l√† ph√¢n kh√∫c "V√†ng" (Store 'a' b√°n ƒë·ªì Basic): TƒÉng tr∆∞·ªüng t·ªõi 48%.
"""

# Map t√™n ƒë·∫ßy ƒë·ªß cho d·ªÖ hi·ªÉu
assort_map = {'a': 'a (Basic)', 'b': 'b (Extra)', 'c': 'c (Extended)'}
df_analysis = df_open.copy()
df_analysis['Assortment_Full'] = df_analysis['Assortment'].map(assort_map)

#  Chu·∫©n b·ªã d·ªØ li·ªáu: Group theo StoreType v√† Assortment
# T√≠nh doanh thu trung b√¨nh
assort_stats = df_analysis.groupby(['StoreType', 'Assortment_Full', 'Promo'])['Sales'].mean().unstack()
assort_stats.columns = ['No_Promo', 'Promo']

# T√≠nh % TƒÉng tr∆∞·ªüng (Uplift)
assort_stats['Uplift_Pct'] = ((assort_stats['Promo'] - assort_stats['No_Promo']) / assort_stats['No_Promo']) * 100

# V·∫Ω bi·ªÉu ƒë·ªì
fig, axes = plt.subplots(1, 2, figsize=(20, 7))

# --- PLOT 1: Heatmap (StoreType vs Assortment) ---
# Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu sang d·∫°ng ma tr·∫≠n cho Heatmap
# Index = Assortment, Columns = StoreType, Values = Uplift %
heatmap_data = assort_stats['Uplift_Pct'].unstack(level=0)

# V·∫Ω Heatmap
sns.heatmap(heatmap_data, annot=True, fmt=".1f",
            cmap=sns.light_palette(ROSSMANN_RED, as_cmap=True), # T√¥ng ƒë·ªè Rossmann
            linewidths=1, linecolor='white',
            cbar_kws={'label': '% TƒÉng tr∆∞·ªüng (Uplift)'},
            ax=axes[0])

axes[0].set_title('B·∫£n ƒë·ªì nhi·ªát: M·ª©c ƒë·ªô "Nghi·ªán Promo" (%)', fontsize=14, fontweight='bold')
axes[0].set_ylabel('Lo·∫°i h√†ng h√≥a (Assortment)')
axes[0].set_xlabel('Lo·∫°i c·ª≠a h√†ng (StoreType)')

# --- PLOT 2: T·ªïng quan theo Assortment (Bar Chart) ---
# T√≠nh trung b√¨nh Uplift ch·ªâ theo Assortment ƒë·ªÉ so s√°nh g·ªôp
assort_only = df_analysis.groupby(['Assortment_Full', 'Promo'])['Sales'].mean().unstack()
assort_only.columns = ['No_Promo', 'Promo']
assort_only['Uplift_Pct'] = ((assort_only['Promo'] - assort_only['No_Promo']) / assort_only['No_Promo']) * 100
assort_only = assort_only.sort_values('Uplift_Pct', ascending=False)

sns.barplot(x=assort_only.index, y=assort_only['Uplift_Pct'], color=MAIN_COLOR, ax=axes[1])
axes[1].set_title('Lo·∫°i h√†ng h√≥a n√†o nh·∫°y c·∫£m v·ªõi Promo nh·∫•t?', fontsize=14, fontweight='bold')
axes[1].set_xlabel('Lo·∫°i h√†ng h√≥a')
axes[1].set_ylabel('% TƒÉng tr∆∞·ªüng')

# Th√™m nh√£n gi√° tr·ªã
for i, v in enumerate(assort_only['Uplift_Pct']):
    axes[1].text(i, v + 1, f"{v:.1f}%", ha='center', fontsize=11, fontweight='bold')

plt.tight_layout()
plt.show()

# --- T·∫†O B·∫¢NG B√ÅO C√ÅO CHI TI·∫æT ---

# 1. T·∫°o b·∫£ng chi ti·∫øt t·ª´ d·ªØ li·ªáu ƒë√£ t√≠nh to√°n (assort_stats)
# assort_stats hi·ªán ƒëang c√≥ MultiIndex (StoreType, Assortment) v√† c·ªôt [No_Promo, Promo, Uplift_Pct]
detailed_report = assort_stats.copy()

# 2. T√≠nh th√™m c·ªôt "Ch√™nh l·ªách tuy·ªát ƒë·ªëi" (Absolute Difference)
# ƒê·ªÉ bi·∫øt khuy·∫øn m√£i mang v·ªÅ th√™m bao nhi√™u ti·ªÅn th·ª±c t·∫ø ch·ª© kh√¥ng ch·ªâ l√† %
detailed_report['Diff_Value'] = detailed_report['Promo'] - detailed_report['No_Promo']

# 3. S·∫Øp x·∫øp l·∫°i c·ªôt cho logic: Kh√¥ng KM -> C√≥ KM -> Ch√™nh l·ªách ti·ªÅn -> % TƒÉng tr∆∞·ªüng
detailed_report = detailed_report[['No_Promo', 'Promo', 'Diff_Value', 'Uplift_Pct']]

# 4. ƒê·ªïi t√™n c·ªôt sang ti·∫øng Vi·ªát cho d·ªÖ ƒë·ªçc
detailed_report.columns = [
    'DS TB (Kh√¥ng KM)',
    'DS TB (C√≥ KM)',
    'TƒÉng th√™m (Ti·ªÅn)',
    '% TƒÉng tr∆∞·ªüng'
]

# 5. S·∫Øp x·∫øp d·ªØ li·ªáu: ∆Øu ti√™n nh√≥m c√≥ % TƒÉng tr∆∞·ªüng cao nh·∫•t l√™n ƒë·∫ßu
detailed_report = detailed_report.sort_values('% TƒÉng tr∆∞·ªüng', ascending=False)

# --- IN K·∫æT QU·∫¢ ---

print("\n" + "="*60)
print("B·∫¢NG PH√ÇN T√çCH CHI TI·∫æT HI·ªÜU QU·∫¢ KHUY·∫æN M√ÉI THEO LO·∫†I H√ÄNG")
print("="*60)

# C√°ch 1: In d·∫°ng text thu·∫ßn (d√πng trong Terminal/Console)
# S·ª≠ d·ª•ng to_string ƒë·ªÉ format s·ªë li·ªáu (2 ch·ªØ s·ªë th·∫≠p ph√¢n)
print(detailed_report.to_string(float_format="{:,.2f}".format))

print("-" * 60)
# C√°ch 2: In ra c√°c Top Insights (Nh·∫≠n x√©t t·ª± ƒë·ªông)
top_seg = detailed_report.index[0] # L·∫•y d√≤ng ƒë·∫ßu ti√™n (cao nh·∫•t)
top_val = detailed_report.iloc[0]['% TƒÉng tr∆∞·ªüng']
top_abs = detailed_report.iloc[0]['TƒÉng th√™m (Ti·ªÅn)']

print(f"\nüí° INSIGHTS QUAN TR·ªåNG:")
print(f"1. Ph√¢n kh√∫c hi·ªáu qu·∫£ nh·∫•t: C·ª≠a h√†ng '{top_seg[0]}' b√°n h√†ng '{top_seg[1]}'.")
print(f"   -> TƒÉng tr∆∞·ªüng: {top_val:.1f}% (T∆∞∆°ng ƒë∆∞∆°ng tƒÉng th√™m {top_abs:,.0f} ƒë∆°n v·ªã ti·ªÅn t·ªá/ng√†y).")

worst_seg = detailed_report.index[-1]
worst_val = detailed_report.iloc[-1]['% TƒÉng tr∆∞·ªüng']
print(f"2. Ph√¢n kh√∫c √≠t nh·∫°y c·∫£m nh·∫•t: C·ª≠a h√†ng '{worst_seg[0]}' b√°n h√†ng '{worst_seg[1]}'.")
print(f"   -> Ch·ªâ tƒÉng tr∆∞·ªüng: {worst_val:.1f}%.")

"""**1."C·∫∑p ƒê√¥i Ho√†n H·∫£o": Store 'a' + Assortment 'a' (Basic)**

H√£y nh√¨n v√†o ng√¥i sao s√°ng nh·∫•t tr√™n b·∫£ng x·∫øp h·∫°ng: C·ª≠a h√†ng lo·∫°i 'a' b√°n c√°c m·∫∑t h√†ng c∆° b·∫£n (Basic).

TƒÉng tr∆∞·ªüng: M·ªôt con s·ªë kh·ªïng l·ªì +48.03%.

Doanh thu tƒÉng th√™m: Trung b√¨nh 2,602 EUR/ng√†y.

StoreType 'a' th∆∞·ªùng l√† c√°c c·ª≠a h√†ng ph·ªë (Street store) g·∫ßn khu d√¢n c∆∞. Assortment 'a' (Basic) l√† nh·ªØng nhu y·∫øu ph·∫©m h√†ng ng√†y: kem ƒë√°nh rƒÉng, s·ªØa t·∫Øm, b·ªôt gi·∫∑t... ƒê√¢y l√† nh·ªØng m·∫∑t h√†ng c√≥ ƒë·ªô nh·∫°y c·∫£m v·ªÅ gi√° c·ª±c cao (High Price Elasticity). Ng∆∞·ªùi d√¢n s·ªëng quanh ƒë√≥ bi·∫øt ch√≠nh x√°c gi√° m·ªôt chai d·∫ßu g·ªôi l√† bao nhi√™u. Ch·ªâ c·∫ßn m·ªôt c√°i tem ƒë·ªè "Gi·∫£m gi√°" d√°n l√™n, h·ªç s·∫Ω mua ngay l·∫≠p t·ª©c, th·∫≠m ch√≠ mua t√≠ch tr·ªØ.

**2. S·ª± "Mi·ªÖn Nhi·ªÖm" C·ªßa C·ª≠a H√†ng 'b' + Assortment 'b' (Extra)**

·ªû chi·ªÅu ng∆∞·ª£c l·∫°i, ch√∫ng ta c√≥ m·ªôt s·ª± l√£ng ph√≠ ngu·ªìn l·ª±c ƒë√°ng b√°o ƒë·ªông. H√£y nh√¨n v√†o C·ª≠a h√†ng lo·∫°i 'b' (S√¢n bay/Nh√† ga) khi b√°n c√°c m·∫∑t h√†ng lo·∫°i 'b' (Extra - H√†ng chuy√™n bi·ªát/b·ªï sung).

TƒÉng tr∆∞·ªüng: Ch·ªâ v·ªèn v·∫πn +7.27%.

 V·ªën dƒ© Store 'b' ƒë√£ c√≥ doanh thu n·ªÅn c·ª±c cao (~8,700), nh∆∞ng khuy·∫øn m√£i g·∫ßn nh∆∞ kh√¥ng t·∫°o ra c√∫ h√≠ch n√†o ƒë√°ng k·ªÉ.

T·∫°i sao l·∫°i th·∫•p th·∫£m h·∫°i nh∆∞ v·∫≠y? Assortment 'b' (Extra) th∆∞·ªùng l√† c√°c s·∫£n ph·∫©m kh√¥ng thi·∫øt y·∫øu ho·∫∑c cao c·∫•p h∆°n. H√£y t∆∞·ªüng t∆∞·ª£ng m·ªôt h√†nh kh√°ch ƒëang v·ªôi v√£ ·ªü s√¢n bay. H·ªç v√†o mua chai n∆∞·ªõc (nhu c·∫ßu thi·∫øt y·∫øu). H·ªç nh√¨n th·∫•y m·ªôt b·ªô m·ªπ ph·∫©m cao c·∫•p (Assortment Extra) ƒëang gi·∫£m gi√°. Li·ªáu h·ªç c√≥ mua kh√¥ng? Kh√¥ng. T√¢m tr√≠ h·ªç ƒëang ·ªü chuy·∫øn bay s·∫Øp t·ªõi. H·ªç kh√¥ng c√≥ t√¢m tr·∫°ng ƒë·ªÉ c√¢n nh·∫Øc mua s·∫Øm nh·ªØng m√≥n ƒë·ªì "Extra" ch·ªâ v√¨ n√≥ r·∫ª h∆°n m·ªôt ch√∫t. T·∫°i ƒë√¢y, khuy·∫øn m√£i tr·ªü n√™n v√¥ h√¨nh.

### B. Th·ªùi ƒëi·ªÉm v√†ng: " Monday" v√† T√¢m l√Ω L·ªÖ h·ªôi
"""

df_open['Month'] = df_open['Date'].dt.month

import pandas as pd

df_open['Month'] = df_open['Date'].dt.month

# ---  PH√ÇN T√çCH HI·ªÜU QU·∫¢ PROMO (TEXT REPORT) ---
print("\n" + "="*50)
print("B√ÅO C√ÅO PH√ÇN T√çCH: TH·ªúI ƒêI·ªÇM √ÅP D·ª§NG PROMO T·ªêT NH·∫§T")
print("="*50)

# ---------------------------------------------------------
# PH·∫¶N A: PH√ÇN T√çCH THEO NG√ÄY TRONG TU·∫¶N (DayOfWeek)
# ---------------------------------------------------------
# T√≠nh trung b√¨nh Sales theo t·ª´ng ng√†y, t√°ch ri√™ng c√≥ Promo (1) v√† ko Promo (0)
day_summary = df_open.groupby(['DayOfWeek', 'Promo'])['Sales'].mean().unstack()

# ƒê·ªïi t√™n c·ªôt cho d·ªÖ hi·ªÉu
day_summary.columns = ['No_Promo_Avg', 'Promo_Avg']

# T√≠nh m·ª©c tƒÉng tr∆∞·ªüng tuy·ªát ƒë·ªëi v√† ph·∫ßn trƒÉm (%)
day_summary['Growth_Abs'] = day_summary['Promo_Avg'] - day_summary['No_Promo_Avg']
day_summary['Growth_Pct'] = (day_summary['Growth_Abs'] / day_summary['No_Promo_Avg']) * 100

# S·∫Øp x·∫øp theo m·ª©c tƒÉng tr∆∞·ªüng % gi·∫£m d·∫ßn
top_days_growth = day_summary.sort_values(by='Growth_Pct', ascending=False)

print("\n[A] HI·ªÜU QU·∫¢ THEO NG√ÄY TRONG TU·∫¶N:")
print(day_summary[['No_Promo_Avg', 'Promo_Avg', 'Growth_Pct']].round(2))

best_day = top_days_growth.index[0]
best_growth = top_days_growth.iloc[0]['Growth_Pct']
print(f"\n=> K·∫æT LU·∫¨N NG√ÄY: Promo hi·ªáu qu·∫£ nh·∫•t v√†o Th·ª© {best_day} (TƒÉng tr∆∞·ªüng {best_growth:.2f}%)")

# ---------------------------------------------------------
# PH·∫¶N B: PH√ÇN T√çCH THEO TH√ÅNG (Seasonality)
# ---------------------------------------------------------
month_summary = df_open.groupby(['Month', 'Promo'])['Sales'].mean().unstack()
month_summary.columns = ['No_Promo_Avg', 'Promo_Avg']

month_summary['Growth_Abs'] = month_summary['Promo_Avg'] - month_summary['No_Promo_Avg']
month_summary['Growth_Pct'] = (month_summary['Growth_Abs'] / month_summary['No_Promo_Avg']) * 100

# T√¨m 3 th√°ng c√≥ m·ª©c tƒÉng tr∆∞·ªüng cao nh·∫•t
top_3_months = month_summary.sort_values(by='Growth_Pct', ascending=False).head(3)

print("\n" + "-"*30)
print("[B] TOP 3 TH√ÅNG C√ì PROMO HI·ªÜU QU·∫¢ NH·∫§T:")
print(top_3_months[['No_Promo_Avg', 'Promo_Avg', 'Growth_Pct']].round(2))

print(f"\n=> K·∫æT LU·∫¨N TH√ÅNG: N√™n ƒë·∫©y m·∫°nh Promo v√†o c√°c th√°ng: {list(top_3_months.index)}")

print("="*50)# --- 2. VISUALIZATION (V·∫Ω bi·ªÉu ƒë·ªì) ---
plt.figure(figsize=(18, 12))

# --- BI·ªÇU ƒê·ªí 1: Hi·ªáu qu·∫£ Promo theo Ng√†y trong tu·∫ßn (DayOfWeek) ---
plt.subplot(2, 1, 1)
# D√πng Barplot ƒë·ªÉ so s√°nh tr·ª±c ti·∫øp m·ª©c Sales trung b√¨nh
sns.barplot(x='DayOfWeek', y='Sales', hue='Promo', data=df_open, palette=PROMO_PALETTE)

plt.title('1. Hi·ªáu qu·∫£ c·ªßa Promo theo Ng√†y trong tu·∫ßn (DayOfWeek)', fontsize=14, fontweight='bold')
plt.xlabel('Th·ª© (1=Th·ª© 2, ..., 7=Ch·ªß Nh·∫≠t)')
plt.ylabel('Doanh thu trung b√¨nh (Sales)')
plt.legend(title='Tr·∫°ng th√°i Promo')

# --- BI·ªÇU ƒê·ªí 2: Hi·ªáu qu·∫£ Promo theo Th√°ng (Seasonality) ---
plt.subplot(2, 1, 2)
# D√πng Lineplot ƒë·ªÉ th·∫•y xu h∆∞·ªõng bi·∫øn ƒë·ªông v√† kho·∫£ng c√°ch (gap) gi·ªØa 2 ƒë∆∞·ªùng
sns.lineplot(x='Month', y='Sales', hue='Promo', data=df_open,
             marker='o', palette=PROMO_PALETTE, linewidth=2.5)

# ƒê√°nh d·∫•u c√°c th√°ng ƒë·∫∑c bi·ªát (V√≠ d·ª•: Th√°ng 12)
plt.axvline(x=12, color='red', linestyle='--', alpha=0.5, label='Th√°ng 12 (Gi√°ng sinh)')

plt.title('2. Hi·ªáu qu·∫£ c·ªßa Promo theo Th√°ng (Seasonality)', fontsize=14, fontweight='bold')
plt.xlabel('Th√°ng')
plt.ylabel('Doanh thu trung b√¨nh')
plt.xticks(range(1, 13)) # Hi·ªÉn th·ªã ƒë·ªß t·ª´ th√°ng 1 ƒë·∫øn 12
plt.legend(title='Tr·∫°ng th√°i Promo')
plt.grid(True, linestyle='--', alpha=0.6)

plt.tight_layout()
plt.show()

"""**- Quy lu·∫≠t Th·ª© Hai**: Th·ª© 7,ch·ªß nh·∫≠t ·ªü ƒê·ª©c, m·ªçi c·ª≠a h√†ng ƒë·ªÅu ƒë√≥ng c·ª≠a( Tr·ª´ c·ª≠a h√†ng "b").Sau kho·∫£ng ngh·ªâ kh√¥ng mua s·∫Øm, nhu c·∫ßu ti√™u d√πng b·ªã "n√©n" l·∫°i nh∆∞ m·ªôt chi·∫øc l√≤ xo ƒê√¢y l√† l√∫c c√°c h·ªô gia ƒë√¨nh nh·∫≠n ra h·ªç ƒë√£ h·∫øt nh·ªØng th·ª© thi·∫øt y·∫øu nh·∫•t
-> Th·ª© Hai tr·ªü th√†nh ng√†y "C·ª©u tr·ª£". Kh√°ch h√†ng ƒë·∫øn Rossmann kh√¥ng ph·∫£i ƒë·ªÉ d·∫°o ch∆°i, h·ªç ƒë·∫øn ƒë·ªÉ l·∫•p ƒë·∫ßy kho d·ª± tr·ªØ.

Khi Rossmann tung khuy·∫øn m√£i v√†o ƒë√∫ng "ƒëi·ªÉm r∆°i" n√†y, n√≥ gi·ªëng nh∆∞ ch√¢m l·ª≠a v√†o th√πng d·∫ßu. Kh√°ch h√†ng kh√¥ng ch·ªâ mua m√≥n ƒë·ªì h·ªç c·∫ßn, m√† khuy·∫øn m√£i khi·∫øn h·ªç mua nhi·ªÅu h∆°n d·ª± ki·∫øn. ƒê√¢y l√† l√Ω do doanh s·ªë Promo ng√†y Th·ª© 2 ƒë·∫°t m·ª©c k·ª∑ l·ª•c (~9.890 ƒë∆°n v·ªã), b·ªè xa c√°c ng√†y kh√°c.

Ng∆∞·ª£c l·∫°i,nh√¨n v√†o Th·ª© 6 (Day 5). TƒÉng tr∆∞·ªüng ch·ªâ ƒë·∫°t 21.92%. T·∫°i sao? V√¨ Th·ª© 6 l√† ng√†y ng∆∞·ªùi ta bu·ªôc ph·∫£i mua ƒë·ªì ƒë·ªÉ chu·∫©n b·ªã cho cu·ªëi tu·∫ßn. D√π c√≥ khuy·∫øn m√£i hay kh√¥ng, h·ªç v·∫´n s·∫Ω mua. Do ƒë√≥, tung Promo v√†o Th·ª© 6 mang l·∫°i hi·ªáu qu·∫£ tƒÉng th√™m th·∫•p nh·∫•t.

**- "M√πa H√® S√¥i ƒê·ªông":**
D·ªØ li·ªáu ch·ªâ ra 3 th√°ng v√†ng: Th√°ng 4, Th√°ng 6, v√† Th√°ng 7 v·ªõi m·ª©c tƒÉng tr∆∞·ªüng x·∫•p x·ªâ 45-46%.

- Th√°ng 4 (Giao m√πa & L·ªÖ Ph·ª•c Sinh): ƒê√¢y l√† l√∫c ng∆∞·ªùi ƒê·ª©c b·∫Øt ƒë·∫ßu ra ngo√†i nhi·ªÅu h∆°n sau m√πa ƒë√¥ng. Th√°ng 4 th∆∞·ªùng g·∫Øn li·ªÅn v·ªõi L·ªÖ Ph·ª•c Sinh (Ostern). C√°c ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i cho b√°nh k·∫πo, qu√† t·∫∑ng v√† ƒë·ªì trang tr√≠ ho·∫°t ƒë·ªông c·ª±c k·ª≥ hi·ªáu qu·∫£.

- Th√°ng 6 & 7 (M√πa du l·ªãch & N·∫Øng n√≥ng): ƒê√¢y l√† cao ƒëi·ªÉm m√πa h√®.

 - - Ng∆∞·ªùi d√¢n chu·∫©n b·ªã cho c√°c k·ª≥ ngh·ªâ d√†i (Urlaub).

- - Nhu c·∫ßu tƒÉng ƒë·ªôt bi·∫øn cho: Kem ch·ªëng n·∫Øng, s·∫£n ph·∫©m chƒÉm s√≥c da, vitamin v√† c√°c v·∫≠t d·ª•ng du l·ªãch c·ª° nh·ªè (travel size).

- - Promo ƒë√°nh v√†o t√¢m l√Ω "mua t√≠ch tr·ªØ tr∆∞·ªõc khi ƒëi ch∆°i" c·ªßa kh√°ch h√†ng ƒë√£ th·∫Øng l·ªõn.
"""

#FEATURE ENGINEERING TR∆Ø∆†ÃÅC L√äÃÉ VAÃÄ SAU L√äÃÉ ( VIÃÄ STATE HOLIDAY C∆ØÃâA HAÃÄNG ƒêOÃÅNG C∆ØÃâA)
#1. ƒê·∫£m b·∫£o d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c s·∫Øp x·∫øp ƒë·ªÉ d√πng h√†m shift ch√≠nh x√°c
df_merge = df_merge.sort_values(['Store', 'Date'])

# 2. Chu·∫©n h√≥a c·ªôt StateHoliday (chuy·ªÉn h·∫øt v·ªÅ string ƒë·ªÉ tr√°nh l·ªói 0 v√† '0')
df_merge['StateHoliday'] = df_merge['StateHoliday'].astype(str)

# 2. TH·ªêNG K√ä TR·∫†NG TH√ÅI C·ª¨A H√ÄNG V√ÄO NG√ÄY L·ªÑ
# Ki·ªÉm tra xem v√†o c√°c ng√†y l·ªÖ (a, b, c), c√≥ bao nhi√™u c·ª≠a h√†ng m·ªü c·ª≠a v√† b√°n ƒë∆∞·ª£c h√†ng?
holiday_analysis = df_merge.groupby('StateHoliday').agg(
    Total_Records=('Store', 'count'),
    Closed_Stores=('Open', lambda x: (x == 0).sum()),
    Zero_Sales=('Sales', lambda x: (x == 0).sum()),
    Mean_Sales=('Sales', 'mean')
)

print("--- TH·ªêNG K√ä TR·∫†NG TH√ÅI C·ª¨A H√ÄNG THEO NG√ÄY L·ªÑ ---")
print(holiday_analysis)

# TH·ªêNG K√ä TR·∫†NG TH√ÅI C·ª¨A H√ÄNG THEO SCHOOL HOLIDAY
# SchoolHoliday: 0 = Ng√†y th∆∞·ªùng (ƒëi h·ªçc), 1 = Ng√†y ngh·ªâ h·ªçc (l·ªÖ, h√®, ƒë√¥ng...)

school_holiday_status = df_merge.groupby('SchoolHoliday').agg(
    Total_Records=('Store', 'count'),
    Closed_Stores=('Open', lambda x: (x == 0).sum()),
    Zero_Sales=('Sales', lambda x: (x == 0).sum()),
    Mean_Sales=('Sales', 'mean')
)

# Define 'groups' here to resolve NameError
groups = df_merge.groupby('Store')['StateHoliday']

# L·∫•y th√¥ng tin ng√†y l·ªÖ c·ªßa 1, 2, 3 ng√†y ti·∫øp theo
df_merge['Holiday_Next_1_Day'] = groups.shift(-1)
df_merge['Holiday_Next_2_Day'] = groups.shift(-2)
df_merge['Holiday_Next_3_Day'] = groups.shift(-3)

# 4. T·∫°o bi·∫øn x√°c ƒë·ªãnh "V·ª´a H·∫øt L·ªÖ" (Look-back / Backward looking)
# L·∫•y th√¥ng tin ng√†y l·ªÖ c·ªßa 1, 2, 3 ng√†y tr∆∞·ªõc ƒë√≥
df_merge['Holiday_Prev_1_Day'] = groups.shift(1)
df_merge['Holiday_Prev_2_Day'] = groups.shift(2)
df_merge['Holiday_Prev_3_Day'] = groups.shift(3)

# 5. T·∫°o c·ªù (Flag) ƒë·ªÉ ph√¢n lo·∫°i ng√†y
# List c√°c m√£ ng√†y l·ªÖ quan tr·ªçng: a (Public), b (Easter), c (Christmas)
# L∆∞u √Ω: '0' l√† ng√†y th∆∞·ªùng
holidays = ['a', 'b', 'c']

# a. C·ªù "S·∫Øp ngh·ªâ l·ªÖ" (Pre-Holiday): N·∫øu 1 trong 3 ng√†y t·ªõi l√† l·ªÖ
def check_pre_holiday(row):
    if (row['Holiday_Next_1_Day'] in holidays) or \
       (row['Holiday_Next_2_Day'] in holidays) or \
       (row['Holiday_Next_3_Day'] in holidays):
        return 1
    return 0

# b. C·ªù "Sau ngh·ªâ l·ªÖ" (Post-Holiday): N·∫øu 1 trong 3 ng√†y tr∆∞·ªõc l√† l·ªÖ
def check_post_holiday(row):
    if (row['Holiday_Prev_1_Day'] in holidays) or \
       (row['Holiday_Prev_2_Day'] in holidays) or \
       (row['Holiday_Prev_3_Day'] in holidays):
        return 1
    return 0

df_merge['Is_Pre_Holiday'] = df_merge.apply(check_pre_holiday, axis=1)
df_merge['Is_Post_Holiday'] = df_merge.apply(check_post_holiday, axis=1)

# L·ªçc l·∫°i data: Ch·ªâ l·∫•y nh·ªØng ng√†y M·ªû C·ª¨A ƒë·ªÉ ph√¢n t√≠ch s·ª©c mua
df_analysis = df_merge[(df_merge['Open'] == 1) & (df_merge['Sales'] > 0)].copy()

print("ƒê√£ t·∫°o xong c√°c bi·∫øn: Is_Pre_Holiday (S·∫Øp ngh·ªâ) v√† Is_Post_Holiday (V·ª´a ngh·ªâ xong)")

"""Ch√∫ng ta th∆∞·ªùng nghƒ©: "L·ªÖ t·∫øt ng∆∞·ªùi ta mua nhi·ªÅu, h√£y khuy·∫øn m√£i tr∆∞·ªõc l·ªÖ". D·ªØ li·ªáu n√≥i: ƒê·ª´ng l√†m v·∫≠y!"""

# ---  HI·ªÜU ·ª®NG T√çCH TR·ªÆ (PRE-HOLIDAY STOCKPILING) ---
print("\n=== 2. HI·ªÜU ·ª®NG T√çCH TR·ªÆ TR∆Ø·ªöC L·ªÑ (PRE-HOLIDAY) ===")
# So s√°nh: Ng√†y th∆∞·ªùng (ko d√≠nh d√°ng l·ªÖ) vs Ng√†y S·∫Øp L·ªÖ
# Lo·∫°i b·ªè nh·ªØng ng√†y v·ª´a l√† Pre v·ª´a l√† Post ƒë·ªÉ clean d·ªØ li·ªáu
df_clean = df_analysis[~((df_analysis['Is_Pre_Holiday']==1) & (df_analysis['Is_Post_Holiday']==1))]

pre_stats = df_clean.groupby(['Is_Pre_Holiday', 'Promo'])['Sales'].mean().unstack()
pre_stats.columns = ['No_Promo', 'Promo']
pre_stats['Uplift'] = ((pre_stats['Promo'] - pre_stats['No_Promo']) / pre_stats['No_Promo']) * 100

print("So s√°nh Doanh thu trung b√¨nh:")
print(pre_stats)

plt.figure(figsize=(14, 6))
plt.subplot(1, 2, 1)
sns.barplot(x='Is_Pre_Holiday', y='Sales', hue='Promo', data=df_clean, palette=PROMO_PALETTE)
plt.title('T√¢m l√Ω t√≠ch tr·ªØ: Mua s·∫Øm 3 ng√†y TR∆Ø·ªöC l·ªÖ', fontsize=12, fontweight='bold')
plt.xlabel('S·∫Øp ƒë·∫øn l·ªÖ ch∆∞a? (0=Kh√¥ng, 1=S·∫Øp)')
plt.ylabel('Sales')
plt.legend(title='Promo')

"""**T√¢m l√Ω tr∆∞·ªõc l·ªÖ (Pre-Holiday)- "Mua v√¨ c·∫ßn, kh√¥ng ph·∫£i v√¨ r·∫ª"**

Ngay c·∫£ khi kh√¥ng c√≥ khuy·∫øn m√£i (No_Promo), doanh thu trung b√¨nh ƒë√£ t·ª± ƒë·ªông nh·∫£y v·ªçt l√™n 6.862 EUR (so v·ªõi ng√†y th∆∞·ªùng ch·ªâ 5.863 EUR). Kh√°ch h√†ng mua v√¨ h·ªç s·ª£ thi·∫øu ƒë·ªì d√πng trong k·ª≥ ngh·ªâ, nhu c·∫ßu l√† c·∫•p thi·∫øt.

C·ª≠a h√†ng v·∫´n ch·∫°y khuy·∫øn m√£i, v√† doanh thu c√≥ tƒÉng l√™n 9.153 EUR. Tuy nhi√™n, m·ª©c ƒë·ªô tƒÉng tr∆∞·ªüng (Uplift) ch·ªâ ƒë·∫°t 33% (th·∫•p h∆°n so v·ªõi ng√†y th∆∞·ªùng l√† 40%).

T·∫°i sao? V√¨ kh√°ch h√†ng ƒëang ·ªü ch·∫ø ƒë·ªô "Mission-driven" (mua theo nhi·ªám v·ª•). D√π b·∫°n c√≥ gi·∫£m gi√° hay kh√¥ng, h·ªç v·∫´n s·∫Ω mua chai d·∫ßu g·ªôi ƒë√≥. Khuy·∫øn m√£i l√∫c n√†y ch·ªâ l√† "ph·∫ßn th∆∞·ªüng th√™m" ch·ª© kh√¥ng ph·∫£i ƒë·ªông l·ª±c ch√≠nh ƒë·ªÉ h·ªç r√∫t v√≠.
"""

# ---  HI·ªÜU ·ª®NG H·∫¨U L·ªÑ (POST-HOLIDAY HANGOVER) ---
print("\n=== 3. T√ÇM L√ù MUA S·∫ÆM SAU L·ªÑ (POST-HOLIDAY) ===")
post_stats = df_clean.groupby(['Is_Post_Holiday', 'Promo'])['Sales'].mean().unstack()
post_stats.columns = ['No_Promo', 'Promo']
post_stats['Uplift'] = ((post_stats['Promo'] - post_stats['No_Promo']) / post_stats['No_Promo']) * 100
print(post_stats)

plt.subplot(1, 2, 2)
sns.barplot(x='Is_Post_Holiday', y='Sales', hue='Promo', data=df_clean, palette=PROMO_PALETTE)
plt.title('T√¢m l√Ω h·∫≠u l·ªÖ: Mua s·∫Øm 3 ng√†y SAU l·ªÖ', fontsize=12, fontweight='bold')
plt.xlabel('V·ª´a h·∫øt l·ªÖ xong? (0=Kh√¥ng, 1=ƒê√∫ng)')
plt.ylabel('Sales')
plt.legend(title='Promo')

plt.tight_layout()
plt.show()

"""**T√¢m l√Ω sau l·ªÖ (Post-Holiday) - "Th·ª£ sƒÉn khuy·∫øn m√£i"**

N·∫øu kh√¥ng c√≥ khuy·∫øn m√£i, kh√°ch h√†ng ch·ªâ mua c·∫ßm ch·ª´ng. Doanh thu trung b√¨nh ƒë·∫°t 6.379 EUR (cao h∆°n ng√†y th∆∞·ªùng m·ªôt ch√∫t do nhu c·∫ßu b·ªï sung h√†ng ti√™u d√πng nhanh ƒë√£ h·∫øt, nh∆∞ng th·∫•p h∆°n tr∆∞·ªõc l·ªÖ).

Nh∆∞ng khi Rossmann tung ra c√°c t·ªù r∆°i khuy·∫øn m√£i, ƒëi·ªÅu k·ª≥ di·ªáu x·∫£y ra. Doanh thu v·ªçt l√™n m·ª©c k·ª∑ l·ª•c 9.331 EUR (cao nh·∫•t trong t·∫•t c·∫£ c√°c k·ªãch b·∫£n).M·ª©c tƒÉng tr∆∞·ªüng (Uplift) ƒë·∫°t t·ªõi 46%

T·∫°i sao? Kh√°ch h√†ng sau l·ªÖ r·∫•t nh·∫°y c·∫£m v·ªÅ gi√°. H·ªç c·∫ßn mua l·∫°i kem ƒë√°nh rƒÉng, b·ªôt gi·∫∑t, t√£ b·ªâm... nh∆∞ng h·ªç ch·ªù ƒë·ª£i m·ªôt l√Ω do ƒë·ªÉ c·∫£m th·∫•y m√¨nh ƒëang chi ti√™u th√¥ng minh. Bi·ªÉn b√°o "Sale" ch√≠nh l√† l√Ω do ƒë√≥.

### C. Chi·∫øn thu·∫≠t ƒê·ªãa l√Ω: Ph√≤ng th·ªß v√† T·∫•n c√¥ng
"""

# --- X·ª¨ L√ù D·ªÆ LI·ªÜU & CHIA NH√ìM KHO·∫¢NG C√ÅCH ---

# 1. X·ª≠ l√Ω gi√° tr·ªã thi·∫øu (n·∫øu c√≥) c·ªßa CompetitionDistance b·∫±ng trung v·ªã
# (Median an to√†n h∆°n Mean v√¨ kho·∫£ng c√°ch th∆∞·ªùng c√≥ outliers r·∫•t l·ªõn)
df_open = df_merge[df_merge['Open'] == 1].copy()
median_dist = df_open['CompetitionDistance'].median()
df_open['CompetitionDistance'].fillna(median_dist, inplace=True)

# 2. Chia nh√≥m (Binning) Kho·∫£ng c√°ch
# Ch√∫ng ta chia theo logic kinh doanh th·ª±c t·∫ø:
# - < 500m: R·∫•t g·∫ßn (C·∫°nh tranh gay g·∫Øt)
# - 500m - 3000m: G·∫ßn (V√πng ·∫£nh h∆∞·ªüng tr·ª±c ti·∫øp)
# - 3000m - 10000m: Xa (√çt ·∫£nh h∆∞·ªüng)
# - > 10000m: R·∫•t xa (G·∫ßn nh∆∞ ƒë·ªôc quy·ªÅn khu v·ª±c)

bins = [0, 500, 3000, 10000, float('inf')]
labels = ['R·∫•t g·∫ßn (<500m)', 'G·∫ßn (500m-3km)', 'Xa (3km-10km)', 'R·∫•t xa (>10km)']

df_open['Competition_Bin'] = pd.cut(df_open['CompetitionDistance'], bins=bins, labels=labels)
# ---  T√çNH TO√ÅN SALES UPLIFT THEO NH√ìM ---

# Groupby theo Bin v√† Promo
comp_stats = df_open.groupby(['Competition_Bin', 'Promo'])['Sales'].mean().unstack()
comp_stats.columns = ['No_Promo', 'Promo']

# T√≠nh % TƒÉng tr∆∞·ªüng (Uplift)
comp_stats['Uplift_Pct'] = ((comp_stats['Promo'] - comp_stats['No_Promo']) / comp_stats['No_Promo']) * 100
comp_stats['Abs_Diff'] = comp_stats['Promo'] - comp_stats['No_Promo']

print("\n--- HI·ªÜU QU·∫¢ PROMO THEO KHO·∫¢NG C√ÅCH ƒê·ªêI TH·ª¶ (Competition Distance) ---")
print(comp_stats)

# --- 1. TR·ª∞C QUAN H√ìA: % UPLIFT ---
fig, ax1 = plt.subplots(figsize=(12, 6))

# [S·ª¨A ƒê·ªîI]: Thay palette=MAIN_COLOR th√†nh color=MAIN_COLOR
# L√Ω do: Khi mu·ªën t√¥ 1 m√†u ƒë·ªìng nh·∫•t, d√πng tham s·ªë 'color' chu·∫©n x√°c h∆°n 'palette'.
sns.barplot(x=comp_stats.index, y=comp_stats['Uplift_Pct'], color=MAIN_COLOR, ax=ax1)

# Trang tr√≠ bi·ªÉu ƒë·ªì
ax1.set_title('S·ª©c m·∫°nh c·ªßa Promo theo Kho·∫£ng c√°ch ƒê·ªëi th·ªß', fontsize=14, fontweight='bold')
ax1.set_ylabel('% TƒÉng tr∆∞·ªüng Doanh thu (Sales Uplift)', fontsize=12, color=PROMO_PALETTE[1]) # D√πng m√†u xanh l√° cho ch·ªØ tr·ª•c tung ƒë·ªÉ ƒë·ªìng b·ªô
ax1.set_xlabel('Kho·∫£ng c√°ch ƒë·∫øn ƒë·ªëi th·ªß c·∫°nh tranh', fontsize=12)

# Hi·ªÉn th·ªã gi√° tr·ªã l√™n c·ªôt
for index, value in enumerate(comp_stats['Uplift_Pct']):
    ax1.text(index, value + 1, f"{value:.1f}%", ha='center', fontsize=11, fontweight='bold')

plt.grid(axis='y', linestyle='--', alpha=0.5)
plt.show()


# --- 2. TR·ª∞C QUAN H√ìA: SO S√ÅNH DOANH THU TUY·ªÜT ƒê·ªêI ---

plt.figure(figsize=(12, 6))

# Chu·∫©n b·ªã d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì (Melt)
# L∆∞u √Ω: C·ªôt c·ªßa comp_stats ƒëang l√† ['No_Promo', 'Promo']
df_melt = comp_stats[['No_Promo', 'Promo']].reset_index().melt(
    id_vars='Competition_Bin',
    var_name='Promo_Status',
    value_name='Avg_Sales'
)

# [S·ª¨A ƒê·ªîI QUAN TR·ªåNG]: T·∫°o Palette √°nh x·∫° t·ª´ t√™n c·ªôt sang m√†u chu·∫©n
# V√¨ c·ªôt d·ªØ li·ªáu l√† ch·ªØ ('No_Promo', 'Promo') nh∆∞ng PROMO_PALETTE d√πng key s·ªë (0, 1)
chart_palette = {
    'No_Promo': PROMO_PALETTE[0], # L·∫•y m√†u x√°m
    'Promo':    PROMO_PALETTE[1]  # L·∫•y m√†u xanh l√°
}

# V·∫Ω bi·ªÉu ƒë·ªì
ax2 = sns.barplot(
    data=df_melt,
    x='Competition_Bin',
    y='Avg_Sales',
    hue='Promo_Status',
    palette=chart_palette # [S·ª¨A ƒê·ªîI]: √Åp d·ª•ng palette m·ªõi t·∫°o
)

plt.title('So s√°nh Doanh thu Tuy·ªát ƒë·ªëi: C√≥ Promo vs Kh√¥ng Promo theo Kho·∫£ng c√°ch', fontsize=14, fontweight='bold')
plt.ylabel('Doanh thu trung b√¨nh (Sales)', fontsize=12)
plt.xlabel('Kho·∫£ng c√°ch ƒë·∫øn ƒë·ªëi th·ªß', fontsize=12)
plt.legend(title='Tr·∫°ng th√°i Promo')

# Hi·ªÉn th·ªã gi√° tr·ªã l√™n t·ª´ng c·ªôt
for p in ax2.patches:
    if p.get_height() > 0:
        # Ch·ªçn m√†u ch·ªØ d·ª±a tr√™n ƒë·ªô cao c·ªôt (t√πy ch·ªçn n√¢ng cao) ho·∫∑c ƒë·ªÉ m·∫∑c ƒë·ªãnh ƒëen
        ax2.annotate(f'{p.get_height():,.0f}',
                     (p.get_x() + p.get_width() / 2., p.get_height()),
                     ha='center', va='center', xytext=(0, 8),
                     textcoords='offset points', fontsize=10, fontweight='bold', color='black')

plt.grid(axis='y', linestyle='--', alpha=0.3)
plt.show()

# --- PH·∫¶N B·ªî SUNG: IN OUTPUT CHI TI·∫æT ---
print("\n" + "="*70)
print("B·∫¢NG PH√ÇN T√çCH CHI TI·∫æT: DOANH THU TUY·ªÜT ƒê·ªêI (TRUNG B√åNH)")
print("="*70)
print(f"{'Nh√≥m Kho·∫£ng C√°ch':<25} | {'Ko Promo (Sales)':<18} | {'C√≥ Promo (Sales)':<18} | {'Ch√™nh l·ªách':<12}")
print("-" * 80)

for index, row in comp_stats.iterrows():
    no_promo = row['No_Promo']
    promo = row['Promo']
    diff = row['Abs_Diff']
    # In ra v·ªõi ƒë·ªãnh d·∫°ng s·ªë c√≥ d·∫•u ph·∫©y ngƒÉn c√°ch h√†ng ngh√¨n
    print(f"{index:<25} | {no_promo:,.0f}             | {promo:,.0f}             | +{diff:,.0f}")

print("-" * 80)

"""- **V√πng "T·ª≠ chi·∫øn" (<500m):** Promo l√† v≈© kh√≠ ph√≤ng th·ªß
T·∫°i khu v·ª±c n√†y, L∆∞·ª£ng kh√°ch tƒÉng t·ªõi 21.5% khi c√≥ Promo.
 ƒê·ªëi th·ªß ·ªü ngay s√°t v√°ch. Kh√°ch h√†ng c√≥ th·ªÉ d·ªÖ d√†ng ƒëi b·ªô sang h√†ng x√≥m n·∫øu th·∫•y gi√° r·∫ª h∆°n.
 Promo ·ªü ƒë√¢y kh√¥ng h·∫≥n ƒë·ªÉ "tƒÉng tr∆∞·ªüng", m√† l√† ƒë·ªÉ "gi√†nh gi·∫≠t & gi·ªØ ch√¢n". N·∫øu b·∫°n kh√¥ng ch·∫°y Promo, kh√°ch h√†ng s·∫Ω l·∫≠p t·ª©c b·ªã ƒë·ªëi th·ªß h√∫t m·∫•t. ƒê√¢y l√† cu·ªôc chi·∫øn s·ªëng c√≤n v·ªÅ th·ªã ph·∫ßn t·∫°i ch·ªó.

- **V√πng "ƒê·ªôc quy·ªÅn" (>10km):** Promo l√† nam ch√¢m h√∫t kh√°ch
ƒê√¢y l√† n∆°i Promo t·ªèa s√°ng nh·∫•t v·ªõi l∆∞·ª£ng kh√°ch tƒÉng v·ªçt 27%.
 C·ª≠a h√†ng n·∫±m ·ªü khu v·ª±c th∆∞a th·ªõt, b√°n k√≠nh ph·ª•c v·ª• r·ªông.
Kh√°ch h√†ng ph·∫£i di chuy·ªÉn xa ƒë·ªÉ mua s·∫Øm. H·ªç s·∫Ω kh√¥ng ƒëi 10km ch·ªâ ƒë·ªÉ mua m·ªôt m√≥n ƒë·ªì gi√° th∆∞·ªùng. Nh∆∞ng khi c√≥ Promo, n√≥ t·∫°o ra m·ªôt "L√Ω do ƒë·ªß l·ªõn" ƒë·ªÉ h·ªç th·ª±c hi·ªán chuy·∫øn ƒëi. Promo bi·∫øn c·ª≠a h√†ng th√†nh m·ªôt ƒëi·ªÉm ƒë·∫øn (Destination), k√≠ch ho·∫°t h√†nh vi "ƒëi m·ªôt l·∫ßn mua cho b√µ".

- **V√πng "L∆∞ng ch·ª´ng" (500m - 10km):**
T·∫°i sao hi·ªáu qu·∫£ ·ªü ƒë√¢y l·∫°i th·∫•p nh·∫•t (18.8%)?
 Kh√¥ng ƒë·ªß g·∫ßn ƒë·ªÉ h√∫t kh√°ch ƒëi b·ªô ti·ªán ƒë∆∞·ªùng nh∆∞ nh√≥m <500m. C≈©ng kh√¥ng ƒë·ªß ƒë·ªôc quy·ªÅn ƒë·ªÉ kh√°ch h√†ng ch·∫•p nh·∫≠n ƒëi xa nh∆∞ nh√≥m >10km.
Kh√°ch h√†ng ·ªü ƒë√¢y c√≥ nhi·ªÅu l·ª±a ch·ªçn thay th·∫ø nh∆∞ng l·∫°i kh√¥ng n·∫±m t·∫≠p trung, khi·∫øn t√°c ƒë·ªông c·ªßa Promo b·ªã lo√£ng ƒëi.

## 3.BONGO

### --- CHI·∫æN L∆Ø·ª¢C ---

**1. STORETYPE**

Ng·ª´ng to√†n b·ªô Promo truy·ªÅn th·ªëng t·∫°i Store 'b': Kh√¥ng ch·∫°y c√°c ch∆∞∆°ng tr√¨nh gi·∫£m gi√° ƒë·∫°i tr√† nh∆∞ c√°c c·ª≠a h√†ng ph·ªë.

Chi·∫øn l∆∞·ª£c thay th·∫ø: T·∫≠p trung v√†o T·ªëc ƒë·ªô & S·ª± s·∫µn c√≥ (Availability). ƒê·∫£m b·∫£o qu·∫ßy k·ªá lu√¥n ƒë·∫ßy ·∫Øp c√°c m·∫∑t h√†ng ti·ªán l·ª£i (n∆∞·ªõc, khƒÉn gi·∫•y, ƒë·ªì ƒÉn nhanh). C√≥ th·ªÉ b√°n c√°c Combo ti·ªán l·ª£i (VD: N∆∞·ªõc + Snack) thay v√¨ gi·∫£m gi√° ƒë∆°n l·∫ª.

D·ªìn ng√¢n s√°ch cho Store 'a' & 'd': Chuy·ªÉn to√†n b·ªô ng√¢n s√°ch Promo ti·∫øt ki·ªám ƒë∆∞·ª£c t·ª´ Store 'b' sang Store 'a' (Khu d√¢n c∆∞) v√† Store 'd' - n∆°i kh√°ch h√†ng c·ª±c k·ª≥ nh·∫°y c·∫£m v·ªõi gi√° v√† ph·∫£n ·ª©ng m·∫°nh v·ªõi khuy·∫øn m√£i (+48%).

**2.ASSORTMENT**
Promo t·∫≠p trung v√†o "R·ªï h√†ng c∆° b·∫£n( a - Basic) ": 80% ng√¢n s√°ch khuy·∫øn m√£i n√™n d√†nh cho c√°c m·∫∑t h√†ng Basic (Kem ƒë√°nh rƒÉng, b·ªôt gi·∫∑t, d·∫ßu g·ªôi, t√£ b·ªâm...). ƒê√¢y l√† nh·ªØng "Traffic Driver" (s·∫£n ph·∫©m k√©o kh√°ch) t·ªët nh·∫•t.

Chi·∫øn thu·∫≠t Cross-sell: Kh√¥ng gi·∫£m gi√° tr·ª±c ti·∫øp h√†ng Extra (M·ªπ ph·∫©m cao c·∫•p, n∆∞·ªõc hoa...) m√† s·ª≠ d·ª•ng h√†ng Basic l√†m m·ªìi nh·ª≠. V√≠ d·ª•: Mua ƒë∆°n h√†ng Basic tr√™n 20 EUR ƒë∆∞·ª£c quy·ªÅn mua h√†ng Extra gi·∫£m gi√°. ƒêi·ªÅu n√†y tr√°nh vi·ªác gi·∫£m gi√° v√¥ √≠ch cho h√†ng Extra khi kh√°ch ch∆∞a c√≥ nhu c·∫ßu.

**3.TH·ªúI ƒêI·ªÇM**

Chi·∫øn d·ªãch "Manic Monday": Tung c√°c Deal s·ªëc nh·∫•t, gi·ªõi h·∫°n s·ªë l∆∞·ª£ng v√†o ng√†y Th·ª© 2 ƒë·ªÉ t·∫≠n d·ª•ng ƒë√† mua s·∫Øm sau ng√†y ngh·ªâ. Bi·∫øn Th·ª© 2 th√†nh th√≥i quen mua s·∫Øm ƒë·ªãnh k·ª≥.

C·∫Øt gi·∫£m Promo ng√†y Th·ª© 6: Gi·ªØ gi√° b√°n th∆∞·ªùng ho·∫∑c khuy·∫øn m√£i nh·∫π v√†o Th·ª© 6, v√¨ kh√°ch h√†ng ki·ªÉu g√¨ c≈©ng ph·∫£i mua ƒë·ªì cho cu·ªëi tu·∫ßn.

Chi·∫øn thu·∫≠t L·ªÖ h·ªôi 2 giai ƒëo·∫°n:

Giai ƒëo·∫°n Tr∆∞·ªõc l·ªÖ (Pre-holiday): T·∫≠p trung v√†o Bundle (Combo) v√† s·ª± ti·ªán l·ª£i. Th√¥ng ƒëi·ªáp: "ƒê·ªß ƒë·ªì cho chuy·∫øn ƒëi tr·ªçn v·∫πn". Kh√¥ng c·∫ßn gi·∫£m gi√° s√¢u.

Giai ƒëo·∫°n Sau l·ªÖ (Post-holiday): Tung ra Deep Discount (Gi·∫£m gi√° s√¢u) ƒë·ªÉ k√≠ch th√≠ch kh√°ch h√†ng Restock (mua ƒë·∫ßy l·∫°i kho) nhu y·∫øu ph·∫©m. ƒê√¢y l√† l√∫c kh√°ch h√†ng c·∫ßn l√Ω do ƒë·ªÉ chi ti·ªÅn nh·∫•t.

**4.V·ªä TR√ç ƒê·ªäA L√ù**

V√πng T·ª≠ chi·∫øn (<500m) - Chi·∫øn l∆∞·ª£c Ph√≤ng th·ªß: Ch·∫°y Promo t·∫ßn su·∫•t d√†y ƒë·∫∑c (High Frequency), thay ƒë·ªïi li√™n t·ª•c ƒë·ªÉ gi·ªØ ch√¢n kh√°ch h√†ng. S·ª≠ d·ª•ng c√°c ch∆∞∆°ng tr√¨nh kh√°ch h√†ng th√¢n thi·∫øt (Loyalty) ƒë·ªÉ h·ªç kh√¥ng b∆∞·ªõc sang c·ª≠a h√†ng ƒë·ªëi th·ªß. Gi√° ph·∫£i c·∫°nh tranh nh·∫•t t·∫°i ƒë√¢y.

V√πng ƒê·ªôc quy·ªÅn (>10km) - Chi·∫øn l∆∞·ª£c Nam ch√¢m: Kh√¥ng c·∫ßn gi·∫£m gi√° l·∫Øt nh·∫Øt. H√£y t·ªï ch·ª©c c√°c ƒë·ª£t "Big Sale" ƒë·ªãnh k·ª≥ (theo th√°ng/qu√Ω) ƒë·ªÉ t·∫°o ƒë·ªông l·ª±c cho kh√°ch h√†ng ƒëi xa m·ªôt l·∫ßn v√† mua s·ªë l∆∞·ª£ng l·ªõn (Bulk buy). Promo ·ªü ƒë√¢y ph·∫£i ƒë·ªß l·ªõn ƒë·ªÉ b√π ƒë·∫Øp chi ph√≠ ƒëi l·∫°i c·ªßa kh√°ch.

V√πng L∆∞ng ch·ª´ng (500m - 10km): T·ªëi ∆∞u h√≥a chi ph√≠ b·∫±ng c√°ch gi·∫£m b·ªõt ng√¢n s√°ch Promo t·∫°i ƒë√¢y. Ch·ªâ ch·∫°y c√°c chi·∫øn d·ªãch l·ªõn to√†n chu·ªói (Mass campaign), kh√¥ng ch·∫°y c√°c Promo c·ª•c b·ªô t·ªën k√©m.

## PROMO2 -" CU·ªòC CHI·∫æN SINH T·ªíN"

## 1.BING

-Promo2 kh√¥ng ph·∫£i l√† m·ªôt c√¥ng c·ª• t·∫•n c√¥ng ng·∫Øn h·∫°n, m√† l√† m·ªôt "t·∫•m khi√™n ph√≤ng th·ªß" d√†i h·∫°n d√†nh cho nh·ªØng c·ª≠a h√†ng ƒëang ch·ªãu √°p l·ª±c c·∫°nh tranh gay g·∫Øt. Tuy nhi√™n, chi·∫øn l∆∞·ª£c n√†y kh√¥ng d√†nh cho t·∫•t c·∫£. ƒê·ªÉ th√†nh c√¥ng, ch√∫ng ta c·∫ßn m·ªôt s·ª± ki√™n nh·∫´n t√†i ch√≠nh tr√™n 5 nƒÉm v√† s·ª± t√†n nh·∫´n c·∫ßn thi·∫øt ƒë·ªÉ "c·∫Øt b·ªè" nh·ªØng ph√¢n kh√∫c ƒëang "ƒë·ªët ti·ªÅn" v√¥ √≠ch.

Ch√∫ng ta s·∫Ω ƒëi qua 3 ƒëi·ªÉm ch√≠nh:

B·ªëi c·∫£nh: T·∫°i sao ch√∫ng ta bu·ªôc ph·∫£i tham gia cu·ªôc chi·∫øn n√†y?

Th·ªùi gian: S·ª©c m·∫°nh c·ªßa l√£i su·∫•t k√©p sau 5 nƒÉm.

Ch·ªçn l·ªçc: Ai n√™n gi·ªØ l·∫°i v√† ai c·∫ßn lo·∫°i b·ªè ngay l·∫≠p t·ª©c?

## 2.BANG

### A.B·ªëi c·∫£nh: V√πng chi·∫øn s·ª± √°c li·ªát

###Ai ƒëang tham gia PROMO2?
"""

import matplotlib.patches as mpatches
from statsmodels.graphics.mosaicplot import mosaic

# df_unique_stores is already created in the notebook context
df_unique_stores = df_open.drop_duplicates(subset=['Store'])[['Store', 'StoreType', 'Promo2']]

# T√≠nh to√°n s·ªë li·ªáu c∆° b·∫£n
crosstab = pd.crosstab(df_unique_stores['StoreType'], df_unique_stores['Promo2'])
store_type_totals = df_unique_stores['StoreType'].value_counts()
total_stores = len(df_unique_stores)

# --- 2. H√ÄM T·∫†O NH√ÉN TH√îNG MINH (SMART LABELIZER) ---
def smart_labelizer(key):
    st_type = key[0]
    p2_status = int(key[1]) # Chuy·ªÉn ƒë·ªïi sang int ƒë·ªÉ d√πng cho crosstab

    count = crosstab.loc[st_type, p2_status]
    pct_in_group = (count / store_type_totals[st_type]) * 100
    global_share = count / total_stores

    # QUY T·∫ÆC HI·ªÇN TH·ªä ƒê·ªÇ TR√ÅNH ƒê√à CH·ªÆ:
    # 1. N·∫øu √¥ chi·∫øm d∆∞·ªõi 1.5% t·ªïng th·ªÉ: ·∫®n ho√†n to√†n
    if global_share < 0.015:
        return ""
    # 2. N·∫øu √¥ nh·ªè (d∆∞·ªõi 5%): Ch·ªâ hi·ªán % cho g·ªçn
    elif global_share < 0.05:
        return f"{count}\n({pct_in_group:.0f}%)"
    # 3. C√°c √¥ l·ªõn: Hi·ªán ƒë·∫ßy ƒë·ªß
    else:
        return f"{count}\n({pct_in_group:.0f}%)"

# --- 3. THI·∫æT L·∫¨P V√Ä V·∫º BI·ªÇU ƒê·ªí ---
fig, ax = plt.subplots(figsize=(20, 10))
plt.rcParams['font.family'] = 'sans-serif'
plt.rcParams['font.size'] = 12 # TƒÉng nh·∫π c·ª° ch·ªØ m·∫∑c ƒë·ªãnh

# ƒê·ªãnh nghƒ©a m√†u s·∫Øc: M·ªôt b·∫£ng m√†u hi·ªán ƒë·∫°i, t∆∞∆°ng ph·∫£n t·ªët
colors = {
    '0': ROSSMANN_GREY,  # X√°m trung t√≠nh (Kh√¥ng tham gia)
    '1': ROSSMANN_RED    # ƒê·ªè Rossmann (C√≥ tham gia)
}

props = lambda key: {
    'color': colors[key[1]],
    'alpha': 1.0,
    'edgecolor': 'white',
    'linewidth': 2.5 # TƒÉng ƒë·ªô d√†y ƒë∆∞·ªùng vi·ªÅn ƒë·ªÉ r√µ h∆°n
}

# V·∫Ω Mosaic
mosaic(df_unique_stores, ['StoreType', 'Promo2'],
       title='', # B·ªè title ·ªü ƒë√¢y ƒë·ªÉ custom b√™n ngo√†i
       labelizer=smart_labelizer,
       properties=props,
       gap=0.03,
       ax=ax,
       label_rotation=0
      )

# --- 4. TRANG TR√ç (TITLE, LEGEND, AXIS) ---
# Ti√™u ƒë·ªÅ
ax.set_title('PH√ÇN B·ªê C·ª¨A H√ÄNG THAM GIA PROMO2 THEO STORE TYPE',
             fontsize=22, fontweight='bold', pad=50, color='#34495E') # M√†u t·ªëi h∆°n cho ti√™u ƒë·ªÅ

# X√≥a khung vi·ªÅn th·ª´a
ax.spines['top'].set_visible(False)
ax.spines['right'].set_visible(False)
ax.spines['bottom'].set_visible(False)
ax.spines['left'].set_visible(False)

# Th√™m nh√£n tr·ª•c th·ªß c√¥ng
ax.text(-0.06, 0.5, 'T·ª∑ l·ªá Promo2 (Tr·ª•c D·ªçc)', rotation=90, va='center',
        fontsize=16, color='#546E7A', fontweight='bold')
ax.text(0.5, -0.08, 'Quy m√¥ StoreType (ƒê·ªô r·ªông c·ªôt)', ha='center',
        fontsize=16, color='#546E7A', fontweight='bold')

# Legend (Ch√∫ th√≠ch)
no_promo_patch = mpatches.Patch(facecolor=colors['0'], edgecolor='white', label='Kh√¥ng tham gia Promo2')
promo_patch = mpatches.Patch(facecolor=colors['1'], edgecolor='white', label='C√≥ tham gia Promo2')
ax.legend(handles=[no_promo_patch, promo_patch],
          loc='upper center', bbox_to_anchor=(0.5, 1.08), # ƒê·∫∑t legend cao h∆°n ch√∫t
          ncol=2, fontsize=14, frameon=False, borderpad=1) # TƒÉng borderpad

plt.tight_layout(rect=[0, 0, 1, 0.95]) # ƒêi·ªÅu ch·ªânh rect ƒë·ªÉ accommodate legend v√† title
plt.show()

# --- 5. IN B·∫¢NG PH·ª§ TR·ª¢ (QUAN TR·ªåNG) ---
# V√¨ ta ƒë√£ ·∫©n s·ªë li·ªáu c·ªßa c√°c √¥ nh·ªè (nh∆∞ StoreType b), ta c·∫ßn in b·∫£ng ra ƒë·ªÉ kh√¥ng m·∫•t th√¥ng tin
print("\n--- B·∫¢NG CHI TI·∫æT S·ªê LI·ªÜU V·ªÄ % C√ÅC C·ª¨A H√ÄNG THAM GIA PROMO2 ---")
summary_table = pd.crosstab(df_unique_stores['StoreType'], df_unique_stores['Promo2'])
summary_table['Total'] = summary_table.sum(axis=1)
summary_table['% Tham Gia'] = (summary_table[1] / summary_table['Total'] * 100).round(1)
print(summary_table)

"""### Tuy nhi√™n h·ªç kh√¥ng c√≥ quy·ªÅn ƒë∆∞·ª£c l·ª±a ch·ªçn MU·ªêN hay KH√îNG MU·ªêN tham gia PROMO2, m√† l√† h·ªç BU·ªòC PH·∫¢I tham gia. B·ªüi v√¨:"""

print("--- KI·ªÇM TRA GI·∫¢ THUY·∫æT C·∫†NH TRANH ---")

# 1. So s√°nh kho·∫£ng c√°ch ƒë·ªëi th·ªß gi·ªØa nh√≥m Promo2 vs Non-Promo2
comp_dist_stats = store.groupby('Promo2')['CompetitionDistance'].describe()
print(comp_dist_stats)

# T·∫°o b·∫£ng m√†u t√πy ch·ªânh: 0 l√† X√°m, 1 l√† ƒê·ªè
custom_palette = {0: ROSSMANN_GREY, 1: ROSSMANN_RED}

# 2. V·∫Ω bi·ªÉu ƒë·ªì ph√¢n ph·ªëi
plt.figure(figsize=(10, 6))

# S·ª¨A ·ªû ƒê√ÇY: Thay palette="muted" th√†nh palette=custom_palette
sns.kdeplot(data=store,
            x='CompetitionDistance',
            hue='Promo2',
            common_norm=False,
            fill=True,
            palette=custom_palette)

plt.title('Ph√¢n ph·ªëi Kho·∫£ng c√°ch ƒë·ªëi th·ªß: C√≥ Promo2 (ƒê·ªè) vs Kh√¥ng Promo2 (X√°m)')
plt.xlim(0, 20000) # Zoom v√†o v√πng kho·∫£ng c√°ch g·∫ßn
plt.xlabel('Kho·∫£ng c√°ch ƒë·∫øn ƒë·ªëi th·ªß (m)')
plt.show()

# 3. Ki·ªÉm tra ch√©o
print("\n--- MA TR·∫¨N STORE TYPE V√Ä ASSORTMENT ---")
print(pd.crosstab(store['StoreType'], store['Assortment']))

"""Khi ph√¢n t√≠ch kho·∫£ng c√°ch ƒë·ªëi th·ªß (CompetitionDistance), d·ªØ li·ªáu cho th·∫•y c√°c c·ª≠a h√†ng tham gia Promo2 ƒëang ·ªü th·∫ø "l∆∞ng d·ª±a t∆∞·ªùng".

- **Nh√≥m KH√îNG tham gia Promo2**: ƒê·ªëi th·ªß ·ªü r·∫•t xa (trung b√¨nh **6,550m**). H·ªç ƒëang ·ªü v√πng an to√†n.

- **Nh√≥m C√ì tham gia Promo2:** ƒê·ªëi th·ªß ·ªü ngay s√°t v√°ch (trung b√¨nh **4,316m**).

=> C√°c c·ª≠a h√†ng tham gia Promo2 ƒëang n·∫±m trong "v√πng chi·∫øn s·ª±" √°c li·ªát. H·ªç t√¨m ƒë·∫øn Promo2 kh√¥ng h·∫≥n ƒë·ªÉ t·∫•n c√¥ng m·ªü r·ªông, m√† tr∆∞·ªõc h·∫øt l√† m·ªôt chi·∫øn l∆∞·ª£c ph√≤ng th·ªß (Defensive Strategy) ƒë·ªÉ gi·ªØ ch√¢n kh√°ch h√†ng tr∆∞·ªõc √°p l·ª±c t·ª´ ƒë·ªëi th·ªß.

### B.Th·ªùi gian: Cu·ªôc ƒëua marathon, kh√¥ng ph·∫£i c√∫ n∆∞·ªõc r√∫t.

N·∫øu ch·ªâ nh√¨n v√†o KPI theo qu√Ω, Promo2 ƒë√£ b·ªã "khai t·ª≠" t·ª´ l√¢u. D·ªØ li·ªáu ch·ª©ng minh m·ªôt h√†nh tr√¨nh t·ª´ "ƒëau ƒë·ªõn" ƒë·∫øn "ng·ªçt ng√†o":
"""

# --- 1. FEATURE ENGINEERING (Gi·ªØ nguy√™n logic t√≠nh th√¢m ni√™n) ---
# L·ªçc d·ªØ li·ªáu ch·ªâ l·∫•y c√°c c·ª≠a h√†ng c√≥ tham gia Promo2
df_p2 = df_open[df_open['Promo2'] == 1].copy()

# T√≠nh th√¢m ni√™n tham gia (Promo2 Tenure)
df_p2['SaleWeek'] = df_p2['Date'].dt.isocalendar().week
df_p2['Promo2_Tenure_Months'] = (
    (df_p2['Date'].dt.year - df_p2['Promo2SinceYear']) * 12 +
    (df_p2['SaleWeek'] - df_p2['Promo2SinceWeek']) / 4.33
)

# L·ªçc b·ªè gi√° tr·ªã √¢m v√† chia nh√≥m th√¢m ni√™n
df_p2 = df_p2[df_p2['Promo2_Tenure_Months'] > 0]
df_p2['Tenure_Group'] = pd.cut(df_p2['Promo2_Tenure_Months'],
                               bins=[0, 12, 24, 36, 48, 60, 100],
                               labels=['<1 NƒÉm', '1-2 NƒÉm', '2-3 NƒÉm', '3-4 NƒÉm', '4-5 NƒÉm', '>5 NƒÉm'])

# --- 2. T√çNH TO√ÅN BASELINE M·ªöI (PH·∫¶N QUAN TR·ªåNG) ---

# Logic: L·∫•y trung b√¨nh doanh thu c·ªßa nh·ªØng ng√†y:
# 1. Kh√¥ng c√≥ Promo th∆∞·ªùng (Promo == 0)
# 2. C·ª≠a h√†ng KH√îNG tham gia Promo2 (Promo2 == 0)
# => ƒê√¢y l√† "S·ª©c b√°n t·ª± nhi√™n" (Organic Sales) c·ªßa h·ªá th·ªëng
mask_normal = (df_open['Promo'] == 0) & (df_open['Promo2'] == 0)
normal_sales_mean = df_open[mask_normal]['Sales'].mean()

# --- 4. IN K·∫æT QU·∫¢ PH√ÇN T√çCH CHI TI·∫æT RA TERMINAL ---

print("\n" + "="*60)
print(" B√ÅO C√ÅO HI·ªÜU QU·∫¢ PROMO2 THEO TH√ÇM NI√äN (vs BASELINE) ")
print("="*60)

# 1. T·ªïng h·ª£p d·ªØ li·ªáu theo nh√≥m
# T√≠nh th√™m 'count' ƒë·ªÉ xem ƒë·ªô tin c·∫≠y c·ªßa d·ªØ li·ªáu (s·ªë l∆∞·ª£ng m·∫´u)
promo2_stats = df_p2.groupby('Tenure_Group', observed=False)['Sales'].agg(['mean', 'count']).reset_index()

# 2. ƒê·ªïi t√™n c·ªôt cho d·ªÖ ƒë·ªçc
promo2_stats.columns = ['Th√¢m Ni√™n (Tenure)', 'Doanh Thu TB', 'S·ªë L∆∞·ª£ng M·∫´u']

# 3. T√≠nh to√°n c√°c ch·ªâ s·ªë so s√°nh v·ªõi Baseline (S·ª©c b√°n t·ª± nhi√™n)
promo2_stats['So v·ªõi Baseline (Abs)'] = promo2_stats['Doanh Thu TB'] - normal_sales_mean
promo2_stats['So v·ªõi Baseline (%)'] = (promo2_stats['So v·ªõi Baseline (Abs)'] / normal_sales_mean) * 100

# 4. ƒê·ªãnh d·∫°ng hi·ªÉn th·ªã ƒë·∫πp cho Terminal
# T·∫°o b·∫£n sao ƒë·ªÉ format chu·ªói (string) cho d·ªÖ ƒë·ªçc, gi·ªØ b·∫£n g·ªëc ƒë·ªÉ t√≠nh to√°n n·∫øu c·∫ßn
display_df = promo2_stats.copy()

display_df['Doanh Thu TB'] = display_df['Doanh Thu TB'].map('{:,.0f}'.format)
display_df['So v·ªõi Baseline (Abs)'] = display_df['So v·ªõi Baseline (Abs)'].map('{:+,.0f}'.format) # Th√™m d·∫•u +/-
display_df['So v·ªõi Baseline (%)'] = display_df['So v·ªõi Baseline (%)'].map('{:+.2f}%'.format)   # Th√™m d·∫•u +/- v√† %
display_df['S·ªë L∆∞·ª£ng M·∫´u'] = display_df['S·ªë L∆∞·ª£ng M·∫´u'].map('{:,.0f}'.format)

# 5. In th√¥ng tin Baseline tr∆∞·ªõc
print(f"\n[*] M·ª®C CHU·∫®N (BASELINE - Organic Sales): {normal_sales_mean:,.0f}")
print("    (ƒê∆∞·ª£c t√≠nh t·ª´: Ng√†y ko Promo + C·ª≠a h√†ng ko tham gia Promo2)\n")

# 6. In b·∫£ng chi ti·∫øt
# S·ª≠ d·ª•ng to_string ƒë·ªÉ in to√†n b·ªô b·∫£ng kh√¥ng b·ªã c·∫Øt d√≤ng
print(display_df.to_string(index=False, justify='center'))

print("\n" + "-"*60)



# --- 3. V·∫º BI·ªÇU ƒê·ªí ---

# --- ƒê·ªäNH NGHƒ®A M√ÄU S·∫ÆC ---
# Gi·∫£ ƒë·ªãnh ROSSMANN_RED v√† ROSSMANN_GREY ƒë√£ ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a tr∆∞·ªõc ƒë√≥.
# N·∫øu ch∆∞a, h√£y b·ªè comment c√°c d√≤ng d∆∞·ªõi ƒë√¢y:
# ROSSMANN_RED = '#C3002D'  # ƒê·ªè ƒë·∫≠m th∆∞∆°ng hi·ªáu
# ROSSMANN_GREY = '#7F7F7F' # X√°m trung t√≠nh

# [M·ªöI] ƒê·ªãnh nghƒ©a m√†u ƒë·ªè nh·∫°t cho Baseline theo y√™u c·∫ßu
# B·∫°n c√≥ th·ªÉ thay ƒë·ªïi m√£ hex n√†y n·∫øu mu·ªën nh·∫°t h∆°n ho·∫∑c ƒë·∫≠m h∆°n m·ªôt ch√∫t.
# V√≠ d·ª• kh√°c: 'salmon', '#E57373', '#FFCDD2'
ROSSMANN_LIGHT_RED = '#FF9999'


fig, ax = plt.subplots(figsize=(14, 7))

# A. V·∫Ω ƒë∆∞·ªùng xu h∆∞·ªõng th√¢m ni√™n c·ªßa nh√≥m C√ì Promo2
sns.lineplot(x='Tenure_Group', y='Sales', data=df_p2,
             marker='o', color=ROSSMANN_RED, linewidth=3, label='Doanh thu C·ª≠a h√†ng Promo2')

# B. V·∫Ω ƒë∆∞·ªùng Baseline (M·ª©c chu·∫©n)
# [ƒê√É S·ª¨A] Thay ƒë·ªïi color t·ª´ ROSSMANN_GREY sang ROSSMANN_LIGHT_RED
plt.axhline(y=normal_sales_mean, color=ROSSMANN_LIGHT_RED, linestyle='--', linewidth=2,
            label=f'Baseline (Ko Promo2): {normal_sales_mean:.0f}')

# Trang tr√≠
plt.title('SO S√ÅNH: HI·ªÜU QU·∫¢ PROMO2 THEO TH√ÇM NI√äN vs S·ª®C B√ÅN T·ª∞ NHI√äN', fontsize=16, fontweight='bold', color='#333333')
plt.xlabel('Th√¢m ni√™n tham gia (Tenure)', fontsize=12)
plt.ylabel('Doanh thu trung b√¨nh', fontsize=12)
plt.legend(loc='upper left', fontsize=11, frameon=True, facecolor='white', framealpha=0.9)
plt.grid(True, linestyle='--', alpha=0.5)

# Th√™m nh√£n gi√° tr·ªã
group_means = df_p2.groupby('Tenure_Group')['Sales'].mean(numeric_only=True)
for i, val in enumerate(group_means):
    if not pd.isna(val):
        ax.text(i, val + 50, f'{val:.0f}', horizontalalignment='center',
                 color=ROSSMANN_RED, fontweight='bold', fontsize=10,
                 bbox=dict(facecolor='white', alpha=0.8, edgecolor='none'))

plt.tight_layout()
plt.show()

"""**1.S·ª± kh·ªüi ƒë·∫ßu b·∫•t l·ª£i (< 1 NƒÉm)**
D·ªØ li·ªáu: Doanh thu 6,305 (Th·∫•p h∆°n m·ª©c chu·∫©n Organic 6,306 m·ªôt ch√∫t, -0.02%).

C·ª≠a h√†ng Rossman ƒëƒÉng k√≠ tham gia promo 2 s·∫Ω b·∫•t l·ª£i ·ªü th·ªùi ƒëi·ªÉm ƒë·∫ßu :  Doanh thu kh√¥ng ƒë·ªïi, th·∫≠m ch√≠ th·∫•p h∆°n 1 ƒë∆°n v·ªã so v·ªõi kh√¥ng l√†m g√¨ c·∫£.

T·∫°i sao? Kh√°ch h√†ng ch∆∞a quen v·ªõi c∆° ch·∫ø m·ªõi. Chi ph√≠ v·∫≠n h√†nh tƒÉng l√™n nh∆∞ng hi·ªáu qu·∫£ ch∆∞a th·∫•y. N·∫øu CEO ch·ªâ nh√¨n v√†o KPI ng·∫Øn h·∫°n (theo qu√Ω), h·ªç c√≥ th·ªÉ ƒë√£ khai t·ª≠ ch∆∞∆°ng tr√¨nh n√†y ngay l·∫≠p t·ª©c v√¨ cho r·∫±ng n√≥ "v√¥ d·ª•ng".

**2.X√¢y d·ª±ng th√≥i quen (1 - 3 NƒÉm)**

D·ªØ li·ªáu: TƒÉng t·ª´ +0.84% l√™n +4.52%.

 C·ª≠a h√†ng ki√™n nh·∫´n duy tr√¨ Promo2 sang nƒÉm th·ª© 2 v√† th·ª© 3. Kh√°ch h√†ng b·∫Øt ƒë·∫ßu nh·∫≠n ra m·∫´u phi·∫øu gi·∫£m gi√° quen thu·ªôc trong th√πng th∆∞ c·ªßa h·ªç.

NƒÉm th·ª© 2: M·ªçi th·ª© nh√≠ch nh·∫π (+53 sale/ng√†y). Ch∆∞a ƒë√°ng k·ªÉ.

NƒÉm th·ª© 3: ƒê·ªôt ph√° b·∫Øt ƒë·∫ßu di·ªÖn ra (+285 sale/ng√†y). Kh√°ch h√†ng ƒë√£ h√¨nh th√†nh th√≥i quen mua s·∫Øm d·ª±a tr√™n chu k·ª≥ c·ªßa Promo2. H·ªç kh√¥ng ch·ªâ ƒë·∫øn mua ng·∫´u nhi√™n n·ªØa (Organic), h·ªç ƒë·∫øn v√¨ Promo2.

**3.ƒêi·ªÉm ng·ªçt ng√†o c·ªßa s·ª± tƒÉng tr∆∞·ªüng (3 - 5 NƒÉm)**

D·ªØ li·ªáu: TƒÉng tr∆∞·ªüng +7.10% ƒë·∫øn +9.53%.

L√∫c n√†y, Promo2 kh√¥ng c√≤n l√† m·ªôt chi ph√≠ marketing n·ªØa, n√≥ l√† m·ªôt c·ªó m√°y in ti·ªÅn. C·ª≠a h√†ng tham gia Promo2 ƒë∆∞·ª£c 4-5 nƒÉm ƒëang b√°n t·ªët h∆°n m·ª©c trung b√¨nh g·∫ßn 600 ƒë∆°n v·ªã s·∫£n ph·∫©m/ng√†y. ƒê√¢y l√† giai ƒëo·∫°n "h√°i qu·∫£ ng·ªçt". Th∆∞∆°ng hi·ªáu c·ªßa c·ª≠a h√†ng g·∫Øn li·ªÅn v·ªõi s·ª± ∆∞u ƒë√£i trong t√¢m tr√≠ ng∆∞·ªùi ti√™u d√πng ƒë·ªãa ph∆∞∆°ng.

**4."ƒê·∫ø ch·∫ø" kh√°ch h√†ng trung th√†nh (> 5 NƒÉm)**

D·ªØ li·ªáu: TƒÉng tr∆∞·ªüng b√πng n·ªï +16.38% (Doanh thu 7,339 vs M·ª©c chu·∫©n 6,306).

ƒê√¢y l√† con s·ªë g√¢y s·ªëc nh·∫•t. Nh·ªØng c·ª≠a h√†ng ki√™n tr√¨ v·ªõi Promo2 tr√™n 5 nƒÉm ƒëang ·ªü m·ªôt ƒë·∫≥ng c·∫•p kh√°c ho√†n to√†n. H·ªç b√°n nhi·ªÅu h∆°n m·ª©c chu·∫©n t·ªõi 1,033 ƒë∆°n v·ªã/ng√†y. Promo2 ·ªü giai ƒëo·∫°n n√†y ƒë√£ t·∫°o ra m·ªôt l·ªõp "khi√™n b·∫£o v·ªá", gi·ªØ ch√¢n kh√°ch h√†ng c·ª±c k·ª≥ ch·∫∑t ch·∫Ω khi·∫øn ƒë·ªëi th·ªß c·∫°nh tranh kh√≥ l√≤ng l√¥i k√©o. ƒê√¢y l√† minh ch·ª©ng cho L·ª£i t·ª©c k√©p (Compound Effect) trong b√°n l·∫ª.

### C. Ch·ªçn l·ªçc: S·ª± th·∫≠t ph≈© ph√†ng v·ªÅ t·ª´ng lo·∫°i c·ª≠a h√†ng (StoreType & Assortment)

Kh√¥ng ph·∫£i ai c≈©ng h∆∞·ªüng l·ª£i t·ª´ "l√£i su·∫•t k√©p" n√†y. Ch√∫ng ta c√≥ nh·ªØng k·∫ª chi·∫øn th·∫Øng v√† nh·ªØng k·∫ª th·∫•t b·∫°i th·∫£m h·∫°i:
"""

# --- 4. IN B√ÅO C√ÅO CHI TI·∫æT RA TERMINAL ---
# Calculate baseline for each StoreType (average sales for stores NOT in Promo2)
# This baseline represents the "natural" sales performance without the long-term Promo2 program.
non_promo2_df = df_open[df_open['Promo2'] == 0]
baseline_data = non_promo2_df.groupby('StoreType')['Sales'].mean().to_dict()

# Get unique store types for iteration
store_types = sorted(df_open['StoreType'].unique())

print("Baseline Sales (Non-Promo2) per StoreType:")
for st, sales in baseline_data.items():
    print(f"  Store Type {st}: {sales:,.0f}")
print("\n" + "="*60)
print(f"{'B√ÅO C√ÅO CHI TI·∫æT: HI·ªÜU QU·∫¢ PROMO2 THEO TH√ÇM NI√äN':^60}")
print("="*60)

for s_type in store_types:
    # 1. L·∫•y d·ªØ li·ªáu
    subset = df_p2[df_p2['StoreType'] == s_type]
    baseline = baseline_data.get(s_type, 0)

    print(f"\nüè∑Ô∏è  STORE TYPE: {s_type}")
    print(f"   ‚ñ∫ M·ª©c chu·∫©n (Kh√¥ng Promo2): {baseline:,.0f} (M·ª•c ti√™u c·∫ßn v∆∞·ª£t)")

    if subset.empty:
        print("   (!) Kh√¥ng c√≥ d·ªØ li·ªáu Promo2 ƒë·ªÉ so s√°nh.")
        continue

    # 2. T√≠nh trung b√¨nh theo nh√≥m th√¢m ni√™n
    group_stats = subset.groupby('Tenure_Group')['Sales'].mean(numeric_only=True)

    # 3. In b·∫£ng so s√°nh
    # Header c·ªßa b·∫£ng con
    print(f"   {'-'*55}")
    print(f"   {'Giai ƒëo·∫°n':<12} | {'Doanh Thu':>10} | {'Ch√™nh l·ªách':>15} | {'Tr·∫°ng th√°i'}")
    print(f"   {'-'*55}")

    first_pass = False # C·ªù ƒë·ªÉ ƒë√°nh d·∫•u l·∫ßn ƒë·∫ßu v∆∞·ª£t m·∫∑t

    for tenure, sales in group_stats.items():
        if pd.isna(sales): continue # B·ªè qua n·∫øu nh√≥m ƒë√≥ kh√¥ng c√≥ d·ªØ li·ªáu

        diff = sales - baseline
        diff_pct = (diff / baseline) * 100

        # X√°c ƒë·ªãnh tr·∫°ng th√°i v√† m√†u s·∫Øc (n·∫øu terminal h·ªó tr·ª£, ·ªü ƒë√¢y d√πng k√Ω t·ª±)
        if diff > 0:
            status = "‚úÖ V∆Ø·ª¢T"
            diff_str = f"+{diff:,.0f} (+{diff_pct:.1f}%)"

            # Ki·ªÉm tra xem ƒë√¢y c√≥ ph·∫£i l·∫ßn ƒë·∫ßu ti√™n v∆∞·ª£t kh√¥ng
            if not first_pass:
                first_pass_msg = tenure
                first_pass = True
        else:
            status = "üîª THUA"
            diff_str = f"{diff:,.0f} ({diff_pct:.1f}%)"

        print(f"   {tenure:<12} | {sales:,.0f}      | {diff_str:>15} | {status}")

    # 4. K·∫øt lu·∫≠n ng·∫Øn g·ªçn cho t·ª´ng StoreType
    print(f"   {'-'*55}")
    if first_pass:
        print(f"   => üåü K·∫æT LU·∫¨N: Promo2 b·∫Øt ƒë·∫ßu c√≥ l√£i th·ª±c s·ª± t·ª´ giai ƒëo·∫°n: {first_pass_msg}")
    else:
        print(f"   => ‚ö†Ô∏è K·∫æT LU·∫¨N: Promo2 ch∆∞a bao gi·ªù ƒë√°nh b·∫°i ƒë∆∞·ª£c nh√≥m kh√¥ng khuy·∫øn m√£i.")
    print("\n")

print("="*60)

# --- 3. V·∫º BI·ªÇU ƒê·ªí FACET (L∆∞·ªõi bi·ªÉu ƒë·ªì) ---
store_types = sorted(df_open['StoreType'].unique())
fig, axes = plt.subplots(2, 2, figsize=(16, 12)) # L∆∞·ªõi 2x2
axes = axes.flatten() # L√†m ph·∫≥ng m·∫£ng ƒë·ªÉ d·ªÖ duy·ªát v√≤ng l·∫∑p
ROSSMANN_RED = '#C3002D'
BASELINE_COLOR = '#c0392b'
for i, s_type in enumerate(store_types):
    ax = axes[i]

    # L·∫•y d·ªØ li·ªáu c·ªßa StoreType hi·ªán t·∫°i
    subset = df_p2[df_p2['StoreType'] == s_type]
    baseline = baseline_data.get(s_type, 0) # L·∫•y m·ª©c chu·∫©n c·ªßa lo·∫°i n√†y

    # N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu th√¨ b·ªè qua
    if subset.empty:
        ax.text(0.5, 0.5, 'Kh√¥ng c√≥ d·ªØ li·ªáu Promo2', ha='center')
        continue

    # A. V·∫Ω ƒë∆∞·ªùng xu h∆∞·ªõng th√¢m ni√™n (ƒê√É S·ª¨A: M√†u ƒê·ªé ROSSMANN)
    sns.lineplot(data=subset, x='Tenure_Group', y='Sales',
                 marker='o', color=ROSSMANN_RED, linewidth=2.5, ax=ax, label='C√≥ Promo2 (Theo th√¢m ni√™n)')

    # B. V·∫Ω ƒë∆∞·ªùng Baseline (Gi·ªØ nguy√™n m√†u ƒê·ªè g·∫°ch)
    ax.axhline(y=baseline, color=BASELINE_COLOR, linestyle='--', linewidth=2,
               label=f'TB Kh√¥ng Promo2 ({baseline:,.0f})')

    # Trang tr√≠ (Gi·ªØ nguy√™n)
    ax.set_title(f'STORE TYPE: {s_type.upper()}', fontsize=14, fontweight='bold', color='#2c3e50')
    ax.set_xlabel('')
    ax.set_ylabel('Doanh thu (Sales)')
    ax.grid(True, linestyle='--', alpha=0.5)
    ax.legend(loc='upper left')

    # ƒê√°nh d·∫•u ƒëi·ªÉm "V∆∞·ª£t m·∫∑t" (Gi·ªØ nguy√™n)
    # L·∫•y gi√° tr·ªã trung b√¨nh t·ª´ng m·ªëc th√¢m ni√™n ƒë·ªÉ so s√°nh
    means = subset.groupby('Tenure_Group')['Sales'].mean(numeric_only=True)
    for idx, (group, val) in enumerate(means.items()):
        if val > baseline:
            # N·∫øu doanh thu > baseline -> T√¥ ƒëi·ªÉm m√†u xanh l√° ƒë·ªÉ highlight
            ax.plot(idx, val, marker='o', markersize=10, color='#2ecc71')
            ax.text(idx, val + 200, 'V∆∞·ª£t!', ha='center', color='#2ecc71', fontweight='bold')

plt.suptitle('H√ÄNH TR√åNH "ƒêU·ªîI K·ªäP" C·ª¶A C·ª¨A H√ÄNG PROMO2 THEO T·ª™NG LO·∫†I C·ª¨A H√ÄNG', fontsize=18, y=1.02)
plt.tight_layout()
plt.show()

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np

# --- 1. CHU·∫®N B·ªä D·ªÆ LI·ªÜU (GI·ªÆ NGUY√äN) ---
# (Gi·∫£ ƒë·ªãnh df_open ƒë√£ c√≥ s·∫µn t·ª´ c√°c b∆∞·ªõc tr∆∞·ªõc c·ªßa b·∫°n)

promo2_df = df_open[df_open['Promo2'] == 1].copy()

promo2_df['Promo2Start'] = pd.to_datetime(
    promo2_df['Promo2SinceYear'].astype(int).astype(str) +
    promo2_df['Promo2SinceWeek'].astype(int).astype(str) + '1',
    format='%Y%W%w'
)

promo2_df['TenureDays'] = (promo2_df['Date'] - promo2_df['Promo2Start']).dt.days
promo2_df['TenureYears'] = promo2_df['TenureDays'] / 365.25

promo2_active = promo2_df[promo2_df['TenureDays'] >= 0].copy()

labels = ['<1 Year', '1-2 Years', '2-3 Years', '3-4 Years', '4-5 Years', '>5 Years']
promo2_active['TenureBin'] = pd.cut(
    promo2_active['TenureYears'],
    bins=[0, 1, 2, 3, 4, 5, 100],
    labels=labels,
    right=False
)

# --- 2. T√çNH TO√ÅN BASELINE & AGGREGATION (GI·ªÆ NGUY√äN) ---

non_promo2 = df_open[df_open['Promo2'] == 0].copy()
baseline_sales_general = non_promo2.groupby('Assortment')['Sales'].mean()

# Aggregation cho H√†ng 1 (Ch·ªâ c·∫ßn 1 b·ªô d·ªØ li·ªáu t·ªïng bao g·ªìm c·∫£ a, b, c)
agg_all = promo2_active.groupby(['Assortment', 'TenureBin'], observed=False)['Sales'].mean().reset_index()

# Baseline chi ti·∫øt cho t·ª´ng Assortment (cho H√†ng 2)
baseline_assortment_dict = non_promo2.groupby('Assortment')['Sales'].mean()
unique_assortments = sorted(promo2_active['Assortment'].unique())

# --- 3. THI·∫æT L·∫¨P KHUNG H√åNH (ƒêI·ªÄU CH·ªàNH LAYOUT) ---

fig = plt.figure(figsize=(24, 16))
gs = fig.add_gridspec(2, 6, hspace=0.3, wspace=0.2)

# ƒê·ªãnh nghƒ©a m√†u s·∫Øc th·ªëng nh·∫•t
ROSSMANN_RED = '#C3002D'
ROSSMANN_GREY = '#555555'
ROSSMANN_LIGHT_GREY = '#AAAAAA'
palette = {
    'c': ROSSMANN_RED,
    'a': ROSSMANN_GREY,
    'b': ROSSMANN_LIGHT_GREY
}

# --- 4. V·∫º H√ÄNG 1: T·ªîNG QUAN T·∫§T C·∫¢ ASSORTMENT ---
ax1 = fig.add_subplot(gs[0, :])

# V·∫Ω Line chart (GI·ªÆ NGUY√äN)
sns.lineplot(data=agg_all, x='TenureBin', y='Sales', hue='Assortment',
             marker='o', linewidth=3, markersize=9, palette=palette, ax=ax1)

# V·∫Ω ƒë∆∞·ªùng baseline (S·ª≠a l·∫°i logic m√†u baseline)
for assortment, baseline in baseline_sales_general.items():
    if assortment in agg_all['Assortment'].unique():

        # LOGIC CH·ªåN M√ÄU M·ªöI: D√πng m√†u c·ªßa line ch√≠nh cho baseline c·ªßa Assortment ƒë√≥
        line_color = palette.get(assortment, '#333333') # L·∫•y m√†u t·ª´ palette

        # ƒêi·ªÅu ch·ªânh ƒë·ªô ƒë·∫≠m nh·∫°t v√† alpha cho Baseline
        if assortment == 'c':
            line_width = 2.5
            line_alpha = 0.8
        elif assortment == 'a':
            line_width = 1.8
            line_alpha = 0.7
        else: # assortment == 'b'
            line_width = 1.5
            line_alpha = 0.6

        ax1.axhline(y=baseline, color=line_color,
                    linestyle='--', alpha=line_alpha, linewidth=line_width,
                    label=f'Base {assortment}')

ax1.set_title('T·ªîNG QUAN: Hi·ªáu qu·∫£ Promo2 ', fontsize=18, fontweight='bold')
ax1.set_ylabel('Doanh Thu Trung B√¨nh', fontsize=14)
ax1.set_xlabel('Th√¢m ni√™n tham gia Promo2 (Tenure)', fontsize=14)
ax1.grid(True, linestyle='--', alpha=0.6)
ax1.legend(title='Assortment', fontsize=12, title_fontsize=13)

# --- 5. V·∫º H√ÄNG 2: CHI TI·∫æT HI·ªÜU QU·∫¢ (GAIN/LOSS) ---

for i, a_type in enumerate(unique_assortments):
    col_start = i * 2
    col_end = col_start + 2
    ax = fig.add_subplot(gs[1, col_start:col_end])

    subset = promo2_active[promo2_active['Assortment'] == a_type]
    baseline = baseline_assortment_dict.get(a_type, 0)

    if subset.empty:
        ax.text(0.5, 0.5, 'Kh√¥ng c√≥ d·ªØ li·ªáu', ha='center')
        continue

    group_means = subset.groupby('TenureBin', observed=False)['Sales'].mean(numeric_only=True)
    x_labels = group_means.index.astype(str)
    y_values = group_means.values

    # L·∫•y m√†u line ch√≠nh x√°c t·ª´ palette
    line_color = palette.get(a_type, '#888888')

    # LOGIC M√ÄU BASELINE: Baseline d√πng ch√≠nh m√†u line nh∆∞ng alpha th·∫•p h∆°n.
    baseline_color = line_color
    if a_type == 'c':
        baseline_alpha = 0.8
        baseline_width = 2.5
    elif a_type == 'a':
        baseline_alpha = 0.7
        baseline_width = 1.8
    else: # a_type == 'b'
        baseline_alpha = 0.6
        baseline_width = 1.5

    # A. V·∫Ω ƒë∆∞·ªùng Baseline (C·∫≠p nh·∫≠t tham s·ªë)
    ax.axhline(y=baseline, color=baseline_color,
               linestyle='--', linewidth=baseline_width, alpha=baseline_alpha,
               label='Baseline')

    # B. V·∫Ω ƒë∆∞·ªùng Promo2 (Gi·ªØ nguy√™n)
    ax.plot(x_labels, y_values, marker='o', color=line_color, linewidth=3, label='C√≥ Promo2')

    # C. T√î M√ÄU (Gi·ªØ nguy√™n)
    # Ph·∫ßn t√¥ m√†u Gain/Loss gi·ªØ nguy√™n logic t√≠nh to√°n, ch·ªâ b·ªã ·∫£nh h∆∞·ªüng b·ªüi Baseline (ƒê√£ s·ª≠a ·ªü tr√™n)
    ax.fill_between(x_labels, y_values, baseline,
                    where=(y_values >= baseline), interpolate=True, color='#2ecc71', alpha=0.3, label='L√£i (Gain)')
    ax.fill_between(x_labels, y_values, baseline,
                    where=(y_values < baseline), interpolate=True, color='#95a5a6', alpha=0.2, label='L·ªó (Loss)')

    # D. SMART ANNOTATION (Gi·ªØ nguy√™n logic t√≠nh to√°n, ch·ªâ ch·ªânh m√†u m≈©i t√™n n·∫øu c·∫ßn)
    y_values_finite = y_values[np.isfinite(y_values)]

    if len(y_values_finite) > 0:
        # Min Point Annotation
        min_val_finite = np.nanmin(y_values_finite)
        min_idx_finite = np.where(y_values == min_val_finite)[0][0]
        # D√πng m√†u x√°m ƒë·∫≠m cho text thay v√¨ ƒë·ªè c≈©
        ax.annotate(f'ƒê√°y: {min_val_finite:.0f}',
                    xy=(min_idx_finite, min_val_finite),
                    xytext=(0, -25), textcoords='offset points',
                    ha='center', color='#333333', fontweight='bold',
                    arrowprops=dict(arrowstyle='->', color='#333333'))

        # End Point Annotation
        end_idx_finite = np.where(np.isfinite(y_values))[0][-1]
        last_y_val = y_values[end_idx_finite]
        diff_end = last_y_val - baseline
        # Status color: Xanh n·∫øu d∆∞∆°ng, ƒê·ªè Rossmann n·∫øu √¢m (ƒë·ªÉ c·∫£nh b√°o)
        status_color = '#27ae60' if diff_end > 0 else ROSSMANN_RED

        ax.annotate(f'{last_y_val:.0f}\n({diff_end:+.0f})',
                    xy=(end_idx_finite, last_y_val),
                    xytext=(0, 20), textcoords='offset points',
                    ha='center', color=status_color, fontweight='bold',
                    bbox=dict(boxstyle="round,pad=0.3", fc="white", ec=status_color, alpha=0.9))

    ax.set_title(f'Chi ti·∫øt: Assortment {a_type}', fontsize=15, fontweight='bold', color='#2c3e50')

    # Thi·∫øt l·∫≠p gi·ªõi h·∫°n tr·ª•c Y
    y_min_lim = np.nanmin(y_values_finite) if len(y_values_finite) > 0 else baseline
    y_max_lim = np.nanmax(y_values_finite) if len(y_values_finite) > 0 else baseline
    ax.set_ylim(bottom=min(y_min_lim, baseline) - 500, top=max(y_max_lim, baseline) + 500)

    ax.grid(True, linestyle=':', alpha=0.6)
    ax.tick_params(axis='x', rotation=20)

    if i == 0:
        ax.legend(loc='upper left', fontsize='small')

plt.suptitle('PH√ÇN T√çCH TO√ÄN DI·ªÜN HI·ªÜU QU·∫¢ PROMO2 THEO TH·ªúI GIAN & LO·∫†I H√ÄNG',
             fontsize=20, fontweight='bold', y=0.95)

plt.tight_layout(rect=[0, 0, 1, 0.95])
plt.show()

# --- 6. T·∫†O V√Ä IN B√ÅO C√ÅO CHI TI·∫æT (GI·ªÆ NGUY√äN) ---

print("\n" + "="*80)
print(" B√ÅO C√ÅO CHI TI·∫æT HI·ªÜU QU·∫¢ PROMO2 (DATA REPORT) ".center(80, "="))
print("="*80 + "\n")

report_df = agg_all.merge(
    pd.Series(baseline_assortment_dict, name='Baseline'),
    on='Assortment',
    how='left'
)

report_df['Diff_Abs'] = report_df['Sales'] - report_df['Baseline']
report_df['Diff_Pct'] = (report_df['Diff_Abs'] / report_df['Baseline']) * 100

for assortment in unique_assortments:
    subset = report_df[report_df['Assortment'] == assortment]
    baseline_val = baseline_assortment_dict.get(assortment, 0)

    print(f"üîπ ASSORTMENT '{assortment.upper()}'")
    print(f"   - M·ª©c Baseline (Kh√¥ng Promo2): {baseline_val:,.0f} Sales")

    start_row = subset[subset['TenureBin'] == '<1 Year']
    end_row = subset[subset['TenureBin'] == '>5 Years']

    if not start_row.empty:
        s_val = start_row['Diff_Pct'].values[0]
        print(f"   - Giai ƒëo·∫°n ƒë·∫ßu (<1 Year): {'TƒÉng' if s_val > 0 else 'Gi·∫£m'} {s_val:+.2f}% so v·ªõi baseline")

    if not end_row.empty:
        e_val = end_row['Diff_Pct'].values[0]
        status = "HI·ªÜU QU·∫¢" if e_val > 0 else "C·∫¶N C√ÇN NH·∫ÆC"
        print(f"   - Giai ƒëo·∫°n cu·ªëi (>5 Years): {'TƒÉng' if e_val > 0 else 'Gi·∫£m'} {e_val:+.2f}% so v·ªõi baseline")
        print(f"   -> ƒê√°nh gi√°: {status}")

    print("-" * 40)

print("\nüìä B·∫¢NG MA TR·∫¨N TƒÇNG TR∆Ø·ªûNG (% GROWTH VS BASELINE)")
print("(Gi√° tr·ªã d∆∞∆°ng = L√£i, Gi√° tr·ªã √¢m = L·ªó)\n")

pivot_growth = report_df.pivot(index='Assortment', columns='TenureBin', values='Diff_Pct')
pd.options.display.float_format = '{:+.2f}%'.format
print(pivot_growth)
pd.reset_option('display.float_format')
print("\n" + "="*80)

# --- 7. KI·ªÇM TRA D·ªÆ LI·ªÜU B·ªä THI·∫æU (GI·ªÆ NGUY√äN) ---
print("\n" + "="*80)
print(" KI·ªÇM TRA S·ªê L∆Ø·ª¢NG D·ªÆ LI·ªÜU (DATA COUNT CHECK) ".center(80, "="))
print("="*80 + "\n")

audit_table = promo2_active.groupby(['Assortment', 'TenureBin'], observed=False).size().unstack(fill_value=0)
print("S·ªë l∆∞·ª£ng b·∫£n ghi d·ªØ li·ªáu (Data Points) t·∫°i m·ªói m·ªëc th√¢m ni√™n:")
print(audit_table)
print("\n" + "-"*80)

if 'b' in audit_table.index:
    assortment_b_counts = audit_table.loc['b']
    missing_bins = assortment_b_counts[assortment_b_counts == 0].index.tolist()
    print(f"üßê PH√ÇN T√çCH ASSORTMENT 'b':")
    if missing_bins:
        print(f"-> D·ªØ li·ªáu ho√†n to√†n TR·ªêNG t·∫°i c√°c kho·∫£ng: {', '.join(missing_bins)}")
        print("-> L√ù DO: Kh√¥ng c√≥ c·ª≠a h√†ng lo·∫°i 'b' n√†o ch·∫°y Promo2 ƒë·ªß l√¢u ƒë·ªÉ ƒë·∫°t ƒë·∫øn c√°c m·ªëc n√†y.")
    else:
        print("-> C√≥ d·ªØ li·ªáu ·ªü t·∫•t c·∫£ c√°c m·ªëc.")
print("\n" + "="*80)

"""**1. NH√ìM "C·∫ÆT L·ªñ NGAY L·∫¨P T·ª®C" (STOP DOING)**
ƒê√¢y l√† khu v·ª±c m√† c√†ng c·ªë g·∫Øng, ch√∫ng ta c√†ng sai l·∫ßm. Promo2 t·∫°i ƒë√¢y kh√¥ng ph·∫£i l√† li·ªÅu thu·ªëc, n√≥ l√† "thu·ªëc ƒë·ªôc".


**Store Type B - "G√£ Kh·ªïng L·ªì Ng·ªß M√™":**

Th·ª±c t·∫ø: V·ªõi doanh thu kh·ªßng khi·∫øp 11k/ng√†y, ch√∫ng ta l·∫ßm t∆∞·ªüng ƒë√¢y l√† m·ªè v√†ng ƒë·ªÉ khai th√°c th√™m b·∫±ng khuy·∫øn m√£i. Nh∆∞ng sai l·∫ßm ch·∫øt ng∆∞·ªùi n·∫±m ·ªü ch·ªó ta ƒë√£ ƒë√°nh ƒë·ªìng "l∆∞·ª£t kh√°ch" v·ªõi "c∆° h·ªôi b√°n gi·∫£m gi√°".


T·∫°i sao ph·∫£i d·ª´ng? Kh√°ch h√†ng t·∫°i Store 'b' (S√¢n bay/Nh√† ga) s·ªü h·ªØu m·ªôt ƒë·∫∑c quy·ªÅn: S·ª± ƒê·ªôc Quy·ªÅn V·ªÅ Th·ªùi Gian & Kh√¥ng Gian. H·ªç mua v√¨ "C·∫ßn G·∫•p", v√¨ h·ªç ƒëang v·ªôi v√£ ch·ªù t√†u xe, ch·ª© kh√¥ng ph·∫£i v√¨ "Gi√° R·∫ª". ƒê·ªô nh·∫°y c·∫£m v·ªÅ gi√° c·ªßa h·ªç g·∫ßn nh∆∞ b·∫±ng kh√¥ng.



H·∫≠u qu·∫£: Khi ch·∫°y Promo2 t·∫°i ƒë√¢y, b·∫°n ƒëang b√°n m·ªôt chai n∆∞·ªõc (th·ª© h·ªç b·∫Øt bu·ªôc ph·∫£i mua) v·ªõi gi√° r·∫ª m·∫°t. B·∫°n ƒëang "t·∫∑ng ti·ªÅn" cho nh·ªØng ng∆∞·ªùi v·ªën dƒ© ƒë√£ s·∫µn s√†ng tr·∫£ ƒë·ªß. Doanh thu c√≥ th·ªÉ cao, nh∆∞ng bi√™n l·ª£i nhu·∫≠n b·ªã b√†o m√≤n v√¥ nghƒ©a.

**Storetype 'b' + Assortment 'b' (H√†ng cao c·∫•p/chuy√™n bi·ªát) - "Sai Th·ªùi ƒêi·ªÉm, Sai T∆∞ Duy":**

Th·ª±c t·∫ø: Con s·ªë l·ªó k·ª∑ l·ª•c -40.96% ngay nƒÉm ƒë·∫ßu ti√™n l√† m·ªôt c√∫ t√°t m·∫°nh v√†o chi·∫øn l∆∞·ª£c gi·∫£m gi√° h√†ng cao c·∫•p.


T·∫°i sao ph·∫£i d·ª´ng? H√£y t∆∞·ªüng t∆∞·ª£ng t√¢m l√Ω kh√°ch h√†ng: H·ªç ƒëang v·ªôi v√£ (nh∆∞ ·ªü Store 'b'), t√¢m tr√≠ h·ªç d·ªìn v√†o chuy·∫øn ƒëi s·∫Øp t·ªõi. H·ªç kh√¥ng c√≥ t√¢m tr·∫°ng ƒë·ªÉ c√¢n nh·∫Øc m·ªôt m√≥n h√†ng xa x·ªâ hay chuy√™n bi·ªát ch·ªâ v√¨ n√≥ r·∫ª h∆°n v√†i ƒë·ªìng.


H·∫≠u qu·∫£: Vi·ªác d√°n tem gi·∫£m gi√° l√™n h√†ng Assortment 'b' kh√¥ng ch·ªâ th·∫•t b·∫°i trong vi·ªác tƒÉng doanh s·ªë m√† c√≤n l√†m "r·∫ª ti·ªÅn h√≥a" h√¨nh ·∫£nh s·∫£n ph·∫©m, khi·∫øn kh√°ch h√†ng nghi ng·ªù gi√° tr·ªã th·ª±c c·ªßa n√≥.

**Store Type C - "V√πng ƒê·∫•t Ch·∫øt":**

Th·ª±c t·∫ø: M·ª©c l·ªó tri·ªÅn mi√™n ~20% l√† minh ch·ª©ng r√µ nh·∫•t cho th·∫•y kh√°ch h√†ng t·∫°i ƒë√¢y ho√†n to√†n "mi·ªÖn nhi·ªÖm" v·ªõi c√°c li·ªÅu thu·ªëc k√≠ch c·∫ßu c·ªßa ch√∫ng ta.

T·∫°i sao ph·∫£i d·ª´ng? C√≥ nh·ªØng v·ªã tr√≠ ƒë·ªãa l√Ω ho·∫∑c t·ªáp kh√°ch h√†ng m√† h√†nh vi mua s·∫Øm c·ªßa h·ªç kh√¥ng ƒë∆∞·ª£c th√∫c ƒë·∫©y b·ªüi c√°c y·∫øu t·ªë ngo·∫°i sinh nh∆∞ Promo. Ti·∫øp t·ª•c ƒë·ªï ti·ªÅn v√†o ƒë√¢y gi·ªëng nh∆∞ c·ªë g·∫Øng t∆∞·ªõi n∆∞·ªõc cho m·ªôt c√°i c√¢y ƒë√£ ch·∫øt kh√¥.



**2. NH√ìM "ƒê·∫¶U T∆Ø D√ÄI H·∫†N" (KEEP DOING)**
Ng∆∞·ª£c l·∫°i v·ªõi b·ª©c tranh ·∫£m ƒë·∫°m tr√™n l√† m·ªôt ƒëi·ªÉm s√°ng ƒë·∫ßy hy v·ªçng, n∆°i "l√£i su·∫•t k√©p" c·ªßa l√≤ng trung th√†nh th·ª±c s·ª± ho·∫°t ƒë·ªông.

**Store Type A & D + Assortment 'c' - "C·∫∑p ƒê√¥i Ho√†n H·∫£o C·ªßa T∆∞∆°ng Lai":**

Th·ª±c t·∫ø: Kh·ªüi ƒë·∫ßu ch·∫≠m ch·∫°p, th·∫≠m ch√≠ ƒëau ƒë·ªõn trong 1-2 nƒÉm ƒë·∫ßu. Nh∆∞ng sau 5 nƒÉm, Assortment 'c' (H√†ng m·ªü r·ªông/m·ªõi) t·∫°i c√°c c·ª≠a h√†ng n√†y v∆∞∆°n l√™n m·∫°nh m·∫Ω, ƒë√°nh b·∫°i m·ª©c chu·∫©n.

T·∫°i sao ph·∫£i ti·∫øp t·ª•c?


ƒê√∫ng ng∆∞·ªùi: Store 'a' & 'd' n·∫±m trong khu d√¢n c∆∞, n∆°i kh√°ch h√†ng c·ª±c k·ª≥ nh·∫°y c·∫£m v·ªÅ gi√° (High Price Elasticity). H·ªç bi·∫øt ch√≠nh x√°c gi√° m·ªôt chai d·∫ßu g·ªôi l√† bao nhi√™u.



ƒê√∫ng chi·∫øn thu·∫≠t: T·∫°i ƒë√¢y, Promo2 ƒë√≥ng vai tr√≤ l√† "ng∆∞·ªùi d·∫´n ƒë∆∞·ªùng". Kh√°ch h√†ng th∆∞·ªùng ng·∫°i th·ª≠ s·∫£n ph·∫©m m·ªõi (Assortment 'c') v√¨ s·ª£ ph√≠ ti·ªÅn. Promo2 h·∫° th·∫•p r√†o c·∫£n ƒë√≥, khuy·∫øn kh√≠ch h·ªç d√πng th·ª≠.

K·∫øt qu·∫£: M·ªôt khi h·ªç ƒë√£ d√πng th·ª≠ v√† th√≠ch (nh·ªù Promo2), h·ªç s·∫Ω h√¨nh th√†nh th√≥i quen. Sau 5 nƒÉm, ch√∫ng ta kh√¥ng ch·ªâ b√°n ƒë∆∞·ª£c h√†ng gi·∫£m gi√°, m√† ch√∫ng ta ƒë√£ x√¢y d·ª±ng ƒë∆∞·ª£c m·ªôt t·ªáp kh√°ch h√†ng trung th√†nh, nh·ªØng ng∆∞·ªùi coi Store 'a'/'d' l√† ƒëi·ªÉm ƒë·∫øn h√†ng ng√†y c·ªßa h·ªç. ƒê√¢y ch√≠nh l√† "ƒê·∫ø ch·∫ø kh√°ch h√†ng" m√† ch√∫ng ta h∆∞·ªõng t·ªõi

## 3. BONGO

### --- CHI·∫æN L∆Ø·ª¢C ---
### 1. Chi·∫øn l∆∞·ª£c "C·∫Øt L·ªó Ngay L·∫≠p T·ª©c" (Stop Doing)
**D·ª´ng ngay Promo2 t·∫°i Store Type B:**

L√Ω do: ƒê√¢y l√† nh·ªØng "Con b√≤ s·ªØa" (Cash Cows) v·ªõi l∆∞·ª£ng kh√°ch t·ª± nhi√™n kh·ªïng l·ªì. ƒê·ª´ng c·ªë g·∫Øng k√≠ch c·∫ßu ·ªü n∆°i c·∫ßu ƒë√£ v∆∞·ª£t cung ho·∫∑c c·∫ßu kh√¥ng nh·∫°y c·∫£m v·ªÅ gi√°.

Thay th·∫ø: T·∫≠p trung v√†o t·ªëi ∆∞u quy tr√¨nh thanh to√°n nhanh, ƒë·∫£m b·∫£o h√†ng lu√¥n ƒë·∫ßy k·ªá (Availability) thay v√¨ gi·∫£m gi√°.

**D·ª´ng Promo2 cho Store Type C:**

L√Ω do: L·ªó tri·ªÅn mi√™n ~20% qua c√°c nƒÉm ch·ª©ng t·ªè t·ªáp kh√°ch h√†ng ·ªü ƒë√¢y kh√¥ng quan t√¢m ƒë·∫øn Promo2.

Thay th·∫ø: C·∫ßn nghi√™n c·ª©u l·∫°i th·ªã tr∆∞·ªùng khu v·ª±c n√†y. C√≥ th·ªÉ v·∫•n ƒë·ªÅ n·∫±m ·ªü v·ªã tr√≠ c·ª≠a h√†ng ho·∫∑c danh m·ª•c s·∫£n ph·∫©m kh√¥ng ph√π h·ª£p v·ªõi d√¢n c∆∞ ƒë·ªãa ph∆∞∆°ng, kh√¥ng ph·∫£i do thi·∫øu khuy·∫øn m√£i.

**Lo·∫°i b·ªè Assortment 'b' (Specialized) kh·ªèi danh m·ª•c khuy·∫øn m√£i:**

L√Ω do: Tr√°nh l√†m m·∫•t gi√° tr·ªã th∆∞∆°ng hi·ªáu c·ªßa d√≤ng h√†ng cao c·∫•p.

Thay th·∫ø: S·ª≠ d·ª•ng chi·∫øn l∆∞·ª£c "Khan hi·∫øm" (Scarcity) ho·∫∑c "Th√†nh vi√™n VIP" thay v√¨ gi·∫£m gi√° ƒë·∫°i tr√†.

### 2. Chi·∫øn l∆∞·ª£c "ƒê·∫ßu T∆∞ D√†i H·∫°n" (Keep Doing & Improve)

**T·∫≠p trung t·ªïng l·ª±c v√†o c·∫∑p ƒë√¥i ho√†n h·∫£o:** Type A/D + Assortment 'c' (Extended): **bold text**

ƒê√¢y l√† nh√≥m duy nh·∫•t ch·ª©ng minh ƒë∆∞·ª£c hi·ªáu qu·∫£ theo th·ªùi gian. Assortment 'c' (h√†ng m·ªü r·ªông) c·∫ßn Promo2 ƒë·ªÉ k√≠ch th√≠ch kh√°ch h√†ng d√πng th·ª≠ c√°c s·∫£n ph·∫©m m·ªõi, t·ª´ ƒë√≥ h√¨nh th√†nh th√≥i quen.

**Thi·∫øt l·∫≠p l·∫°i KPI ƒë√°nh gi√°:**

V·ªõi nh√≥m c·ª≠a h√†ng n√†y, c·∫•m ƒë√°nh gi√° hi·ªáu qu·∫£ Promo2 theo Qu√Ω ho·∫∑c NƒÉm ƒë·∫ßu ti√™n.

Ch·∫•p nh·∫≠n "g·ªìng l·ªó" ho·∫∑c h√≤a v·ªën trong 3 nƒÉm ƒë·∫ßu (giai ƒëo·∫°n gi√°o d·ª•c th·ªã tr∆∞·ªùng).

Cam k·∫øt t√†i ch√≠nh t·ªëi thi·ªÉu 5 nƒÉm ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm r∆°i phong ƒë·ªô (+16% tƒÉng tr∆∞·ªüng).

### 3. Chi·∫øn l∆∞·ª£c "T√°i ƒê·ªãnh V·ªã" cho Assortment 'a' (Basic)

Th·ª±c t·∫ø: H√†ng c∆° b·∫£n a- Basic (kem ƒë√°nh rƒÉng, x√† ph√≤ng...) c√≥ bi√™n l·ª£i nhu·∫≠n m·ªèng v√† nhu c·∫ßu ·ªïn ƒë·ªãnh. Promo2 kh√¥ng l√†m tƒÉng s·ª©c mua ƒë·ªôt bi·∫øn (ƒÉn bao nhi√™u c≈©ng ch·ªâ d√πng b·∫•y nhi√™u).

H√†nh ƒë·ªông: Kh√¥ng ch·∫°y Promo2 ƒë∆°n l·∫ª cho Assortment 'a'. Ch·ªâ s·ª≠ d·ª•ng Assortment 'a' l√†m "M·ªìi c√¢u" (Loss Leader) trong c√°c g√≥i combo ƒë·ªÉ b√°n k√®m Assortment 'c'.

V√≠ d·ª•: Kh√¥ng gi·∫£m gi√° tu√Ωp kem ƒë√°nh rƒÉng (Type a). Nh∆∞ng gi·∫£m gi√° tu√Ωp kem ƒë√°nh rƒÉng N·∫æU mua k√®m m·ªôt chai n∆∞·ªõc hoa ho·∫∑c m·ªπ ph·∫©m d∆∞·ª°ng da (Type c).
"""